<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Grazzy — Notifications (Social Feed)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <style>
    *,*::before,*::after{box-sizing:border-box}
    :root{
      --bg:#0f172a; /* fallback background */
      --card:rgba(255,255,255,0.03);
      --muted:#94a3b8;
      --radius:14px;
      /* honor project variables with fallbacks */
      --blue: var(--accent-color, #00d5ff);
      --pink: var(--theme-pink, #ff2e92);
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(135deg,var(--bg),#1a1a2e);color:#e6eef8}
    header{position:sticky;top:0;background:linear-gradient(135deg,rgba(8,10,20,.9),rgba(10,10,20,.75));backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,0.04);z-index:50}
    .header-wrap{max-width:1200px;margin:0 auto;padding:12px 18px;display:flex;align-items:center;gap:12px}
    .logo{font-family:Poppins, sans-serif;font-weight:800;background-image:linear-gradient(90deg,var(--blue),var(--pink));-webkit-background-clip:text;background-clip:text;color:transparent;font-size:1.2rem;text-decoration:none}
    .toolbar-actions{margin-left:auto;display:flex;gap:8px;align-items:center}
    .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:10px;color:inherit;cursor:pointer}
    /* header profile */
    #profileLink{display:inline-flex;align-items:center;gap:8px;text-decoration:none;color:inherit}
    #headerProfilePic{display:none;width:36px;height:36px;border-radius:50%;object-fit:cover;border:1px solid rgba(255,255,255,0.18)}
    #headerAvatarIcon{font-size:32px;display:none}
    #headerDisplayName{font-weight:800;max-width:180px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    main{max-width:980px;margin:18px auto;padding:0 12px}

    /* Controls */
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:14px}
    .tabs{display:flex;gap:8px;overflow:auto}
    .tab{padding:8px 12px;border-radius:999px;background:transparent;border:1px solid rgba(255,255,255,0.03);cursor:pointer;color:var(--muted);white-space:nowrap;display:inline-flex;align-items:center;gap:6px}
    .tab.active{background:linear-gradient(90deg,var(--blue),var(--pink));color:#091022;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
    .tab-count{display:none;min-width:18px;height:18px;border-radius:999px;background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.1);color:inherit;font-size:.75rem;line-height:18px;text-align:center;padding:0 6px}
    .search{flex:1;display:flex;align-items:center;background:var(--card);padding:8px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    .search-input{flex:1;background:transparent;border:0;color:inherit;outline:none;padding:6px}
    .search-icon{margin-right:8px;color:var(--muted)}
    .mark-all{display:inline-flex;gap:8px;align-items:center}
    .mark-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:10px;color:inherit;cursor:pointer;white-space:nowrap}

    /* Feed */
    .feed{display:flex;flex-direction:column;gap:12px}
    .thread{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);border-radius:12px;padding:10px;display:flex;gap:12px;align-items:flex-start;transition:transform .18s ease,box-shadow .18s ease}
    .thread:hover{transform:translateY(-6px);box-shadow:0 12px 40px rgba(0,0,0,0.6)}
    .thread.unread{box-shadow:0 0 0 3px rgba(0,213,255,0.06) inset}
    .avatar-col{flex:0 0 56px}
    .avatar{width:56px;height:56px;border-radius:50%;overflow:hidden;border:2px solid rgba(255,255,255,0.04);object-fit:cover}
    .content{flex:1;min-width:0}
    .thread-header{display:flex;align-items:center;gap:8px}
    .actor-name{font-weight:700}
    .actor-line{display:flex;gap:6px;align-items:baseline;min-width:0}
    .actor-snippet{color:var(--muted);min-width:0;overflow:hidden;text-overflow:ellipsis}
    .thread-meta{margin-left:auto;display:flex;gap:8px;align-items:center;color:var(--muted);font-size:.85rem}
    .priority-badge{background:linear-gradient(90deg,var(--blue),var(--pink));padding:4px 8px;border-radius:999px;color:#061020;font-weight:800;font-size:.75rem}

    .thread-body{display:flex;align-items:flex-start;gap:12px;margin-top:8px}
    .message{color:var(--muted);font-size:.95rem;line-height:1.25;overflow:hidden;text-overflow:ellipsis}
    .media-thumb{width:72px;height:72px;border-radius:8px;flex:0 0 72px;object-fit:cover;border:1px solid rgba(255,255,255,0.03)}

    .thread-actions{display:flex;gap:8px;margin-top:10px}
    .action-btn{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:6px 10px;border-radius:999px;cursor:pointer;color:var(--muted)}
    .action-btn.primary{background:linear-gradient(90deg,var(--blue),var(--pink));color:#071022;border:none}

    .expanded-list{margin-top:10px;display:none;flex-direction:column;gap:6px}
    .thread.expanded .expanded-list{display:flex}
    .item-small{display:flex;gap:8px;align-items:flex-start;padding:8px;border-radius:10px;background:rgba(0,0,0,0.05);border:1px solid rgba(255,255,255,0.01)}
    .item-small .avatar{width:40px;height:40px}
    .item-text{min-width:0}
    .item-name{font-weight:700}
    .item-meta{font-size:.85rem;color:var(--muted)}

    /* Context menu */
    .context-menu{position:absolute;right:20px;min-width:160px;background:var(--card);padding:8px;border:1px solid rgba(255,255,255,0.04);border-radius:8px;box-shadow:0 12px 30px rgba(0,0,0,0.5)}
    .context-item{padding:8px;border-radius:6px;cursor:pointer}
    .context-item:hover{background:rgba(255,255,255,0.04)}
    .context-danger{color:#f87171}

    /* Prefs popover */
    .prefs-pop{position:absolute;top:56px;right:12px;background:var(--card);border:1px solid rgba(255,255,255,0.06);border-radius:12px;padding:12px;min-width:220px;box-shadow:0 12px 30px rgba(0,0,0,0.5);display:none}
    .prefs-row{display:flex;justify-content:space-between;align-items:center;margin:6px 0}
    .prefs-title{font-weight:800;margin:0 0 6px 0}

    /* Empty */
    .empty{border:1px solid rgba(255,255,255,0.03);border-radius:12px;padding:28px;text-align:center;color:var(--muted);background:var(--card)}
    .empty-title{font-weight:700;font-size:1.05rem}
    .empty-desc{margin-top:8px;color:var(--muted)}

    /* Toast */
    .toast{position:fixed;right:16px;bottom:16px;z-index:90;padding:12px 14px;border-radius:12px;background:linear-gradient(90deg,var(--blue),var(--pink));color:#04111a;font-weight:700;box-shadow:0 8px 30px rgba(0,0,0,0.6);display:none}

    .bottom-space{height:40px}

    /* responsive */
    @media (max-width:600px){.avatar{width:48px;height:48px}.avatar-col{flex:0 0 48px}.media-thumb{width:56px;height:56px}}
  </style>
</head>
<body>
  <header>
    <div class="header-wrap">
      <a class="logo" href="/">Grazzy</a>
      <div class="toolbar-actions">
        <button class="btn" id="backBtn" aria-label="Go back"><i class="fa-solid fa-arrow-left"></i></button>
        <button class="btn" id="openPrefs" aria-haspopup="true" aria-expanded="false" aria-controls="prefsPopover" title="Notification preferences"><i class="fa-solid fa-bell-slash"></i></button>
        <a href="/profile.html" id="profileLink" aria-label="View Profile">
          <img id="headerProfilePic" src="" alt="Profile Picture">
          <i id="headerAvatarIcon" class="fas fa-user-circle" aria-hidden="true"></i>
          <span id="headerDisplayName">Loading...</span>
        </a>
      </div>
    </div>
  </header>

  <main>
    <div class="controls">
      <div class="tabs" role="tablist" aria-label="Notification categories">
        <button class="tab active" data-tab="all" role="tab" aria-selected="true">All</button>
        <button class="tab" data-tab="mentions" role="tab">Mentions</button>
        <button class="tab" data-tab="messages" role="tab">Messages</button>
        <button class="tab" data-tab="likes" role="tab">Likes</button>
        <button class="tab" data-tab="comments" role="tab">Comments</button>
        <button class="tab" data-tab="shares" role="tab">Shares</button>
        <button class="tab" data-tab="follows" role="tab">Follows</button>
        <button class="tab" data-tab="groups" role="tab">Groups</button>
        <button class="tab" data-tab="events" role="tab">Events</button>
        <button class="tab" data-tab="system" role="tab">System</button>
        <button class="tab" data-tab="tags" role="tab">Tags</button>
      </div>
      <div class="search" role="search">
        <i class="fa-solid fa-magnifying-glass search-icon" aria-hidden="true"></i>
        <input id="searchInput" class="search-input" placeholder="Search notifications, people or posts" aria-label="Search notifications" />
      </div>
      <div class="mark-all">
        <button id="markAllBtn" class="mark-btn" title="Mark all as read"><i class="fa-regular fa-envelope-open"></i> Mark all</button>
      </div>
    </div>

    <div id="feed" class="feed" aria-live="polite"></div>

    <div id="emptyState" class="empty" style="display:none">
      <div class="empty-title">You're all caught up</div>
      <div class="empty-desc">We��ll show new activity here. Try adjusting filters or preferences for more results.</div>
    </div>

    <div class="bottom-space"></div>
  </main>

  <div id="prefsPopover" class="prefs-pop" role="dialog" aria-modal="false" aria-labelledby="prefsTitle">
    <div class="prefs-title" id="prefsTitle">Notification preferences</div>
    <div class="prefs-row"><span>Do Not Disturb</span><label><input type="checkbox" id="prefDnd"> DND</label></div>
    <div class="prefs-row"><span>Sound</span><label><input type="checkbox" id="prefSound"> Beep</label></div>
    <div class="prefs-row"><button class="btn" id="clearCacheBtn"><i class="fa-solid fa-broom"></i> Clear cache</button></div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.8.0/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.8.0/firebase-auth.js';
    import { getFirestore, collection, query, orderBy, limit, onSnapshot, doc, updateDoc, deleteDoc, getDoc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/11.8.0/firebase-firestore.js';
    import { getCloudinaryImageUrl, displayProfilePicture } from './assets/js/avatar-utils.js';

    const firebaseConfig = typeof window.__firebase_config !== 'undefined' ? JSON.parse(window.__firebase_config) : {
      apiKey: "AIzaSyDz-8N0totzvMCvonF9pKj9RsoH3J8xL0w",
      authDomain: "jchat-1.firebaseapp.com",
      projectId: "jchat-1"
    };
    const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Initialize Firebase Messaging support (optional VAPID key provided via global)
    import('https://www.gstatic.com/firebasejs/11.8.0/firebase-messaging.js').then(({ getMessaging, getToken, onMessage })=>{
      // Expose an async initializer that will be called after auth is ready and service worker registered
      window.__nuviaInitFCM = async function(currentUser){
        try{
          if (!('serviceWorker' in navigator)) return;
          const swReg = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
          const messaging = getMessaging(app);

          // Request notification permission if not already granted
          if (Notification.permission !== 'granted') {
            try { await Notification.requestPermission(); } catch(_){}
          }
          if (Notification.permission !== 'granted') {
            console.warn('Grazzy: Notifications permission not granted');
            return;
          }

          // Attempt to get token. VAPID key can be provided at runtime via window.__firebase_messaging_vapid_key
          const vapidKey = window.__firebase_messaging_vapid_key || null;
          const getOptions = vapidKey ? { vapidKey } : {};

          let fcmToken = null;
          try {
            fcmToken = await getToken(messaging, { serviceWorkerRegistration: swReg, vapidKey: vapidKey || undefined });
          } catch (e) {
            console.warn('Grazzy: getToken failed', e);
          }

          if (fcmToken) {
            try {
              if (currentUser && currentUser.uid) {
                const tokenRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'fcmTokens', fcmToken);
                await setDoc(tokenRef, { token: fcmToken, ts: serverTimestamp(), userAgent: navigator.userAgent });
              }
            } catch (e) { console.warn('Grazzy: Failed saving FCM token', e); }
          }

          // Handle incoming foreground messages
          try{
            onMessage(messaging, (payload)=>{
              try{
                const title = (payload && (payload.notification && payload.notification.title)) || (payload && payload.data && payload.data.title) || 'Grazzy Notification';
                const body = (payload && (payload.notification && payload.notification.body)) || (payload && payload.data && payload.data.body) || '';
                // Show a native notification if permitted
                try{ new Notification(title, { body }); } catch(e){ /* fallback to in-app toast */ notify(body,'info'); }
              }catch(e){ console.warn('FCM onMessage handler error', e); }
            });
          }catch(e){ /* ignore */ }

        }catch(e){ console.error('Grazzy: FCM init error', e); }
      };
    }).catch(e=>{ console.warn('Grazzy: Failed to load firebase-messaging.js', e); });

    (function(){
      const feedEl = document.getElementById('feed');
      const emptyEl = document.getElementById('emptyState');
      const toastEl = document.getElementById('toast');
      const tabs = Array.from(document.querySelectorAll('.tab'));
      const searchInput = document.getElementById('searchInput');

      // Deep link: capture initial params (apply after currentTab declared)
      const __dl = (function(){ try{ const u=new URL(window.location.href); return { tab:(u.searchParams.get('tab')||'all').toLowerCase(), q:(u.searchParams.get('q')||'') }; }catch(_){ return { tab:'all', q:'' }; } })();
      if (__dl.q) searchInput.value = __dl.q;
      const markAllBtn = document.getElementById('markAllBtn');
      const backBtn = document.getElementById('backBtn');
      const prefsBtn = document.getElementById('openPrefs');
      const prefsPop = document.getElementById('prefsPopover');
      const prefDnd = document.getElementById('prefDnd');
      const prefSound = document.getElementById('prefSound');
      const clearCacheBtn = document.getElementById('clearCacheBtn');
      const headerProfilePic = document.getElementById('headerProfilePic');
      const headerAvatarIcon = document.getElementById('headerAvatarIcon');
      const headerDisplayName = document.getElementById('headerDisplayName');
      const profileLink = document.getElementById('profileLink');

      let currentTab = 'all';
      let currentUser = null;
      let items = [];
      let unsubscribe = null;
      let prefs = loadPrefs();

      // Apply deep link now that currentTab exists
      if (tabs.find(t=>t.dataset.tab===__dl.tab)) {
        currentTab = __dl.tab;
        tabs.forEach(x=>x.classList.toggle('active', x.dataset.tab===__dl.tab));
        tabs.forEach(x=>x.setAttribute('aria-selected', String(x.dataset.tab===__dl.tab)));
      }

      function loadPrefs(){ try{ return Object.assign({dnd:false,sound:true,muted:[],snoozed:{}}, JSON.parse(localStorage.getItem('nuvia_notification_prefs')||'{}')); }catch(e){ return {dnd:false,sound:true,muted:[],snoozed:{}}; } }
      function savePrefs(){ localStorage.setItem('nuvia_notification_prefs', JSON.stringify(prefs)); }

      tabs.forEach(t=>t.addEventListener('click',()=>{ tabs.forEach(x=>x.classList.toggle('active',x===t)); tabs.forEach(x=>x.setAttribute('aria-selected', String(x===t))); currentTab = t.dataset.tab; syncUrl(); render(); }));
      searchInput.addEventListener('input', debounce(()=>{ syncUrl(); render(); },220));
      markAllBtn.addEventListener('click', async ()=>{ const scoped = getCurrentFilteredItems(); if(scoped.length===0) return; await markAllAsRead(scoped); notify('All visible marked as read','info'); });
      backBtn.addEventListener('click',()=>window.history.back());

      // Prefs UI
      function syncPrefsUI(){ prefDnd.checked = !!prefs.dnd; prefSound.checked = !!prefs.sound; }
      function togglePrefs(){ const open = prefsPop.style.display!=="block"; prefsPop.style.display = open? 'block':'none'; prefsBtn.setAttribute('aria-expanded', String(open)); if(open) syncPrefsUI(); }
      prefsBtn.addEventListener('click', (e)=>{ e.stopPropagation(); togglePrefs(); });
      document.addEventListener('click', (e)=>{ if(!prefsPop.contains(e.target) && e.target!==prefsBtn){ prefsPop.style.display='none'; prefsBtn.setAttribute('aria-expanded','false'); } });
      prefDnd.addEventListener('change', ()=>{ prefs.dnd = prefDnd.checked; savePrefs(); });
      prefSound.addEventListener('change', ()=>{ prefs.sound = prefSound.checked; savePrefs(); });
      clearCacheBtn.addEventListener('click', ()=>{ try{ localStorage.removeItem('nuvia_notifications_cache'); notify('Cache cleared','info'); }catch(_){} });

      onAuthStateChanged(auth, async (u)=>{
        currentUser = u || null;
        if(unsubscribe){ try{ unsubscribe(); }catch(e){} unsubscribe=null; }
        if(!currentUser){
          if (headerDisplayName) headerDisplayName.textContent = 'Guest';
          if (headerProfilePic) headerProfilePic.style.display = 'none';
          if (headerAvatarIcon) headerAvatarIcon.style.display = 'block';
          return loadCachedAndRender();
        }
        try{ await fetchAndDisplayHeaderProfile(currentUser); }catch(_){ }

        // Initialize FCM for this authenticated user (if messaging SDK loaded)
        try{ if (typeof window.__nuviaInitFCM === 'function') { window.__nuviaInitFCM(currentUser).catch(()=>{}); } }catch(_){}

        const col = collection(db,'artifacts', appId, 'users', currentUser.uid, 'notifications');
        const q = query(col, orderBy('timestamp','desc'), limit(400));
        let __notifInitialized = false;
        unsubscribe = onSnapshot(q, snap=>{
          const arr = [];
          snap.forEach(s=>{ arr.push(map(s.id, s.data())); });
          // detect newly received notifications since last snapshot
          try{
            const prevIds = new Set(items.map(i=>i.id));
            const newItems = arr.filter(i=>!prevIds.has(i.id) && i.unread);
            // update items and UI
            items = arr; cacheItems(); render(); updateGlobalUnreadCount();
            // play sound for new notifications only after initial load
            if(__notifInitialized && newItems.length>0){
              try{
                if (prefs.sound && !prefs.dnd){
                  if (!__notifAudio) { __notifAudio = new Audio('ne.mp3'); __notifAudio.preload = 'auto'; __notifAudio.volume = 0.7; }
                  __notifAudio.currentTime = 0; __notifAudio.play().catch(()=>{});
                }
              }catch(_){ }
            }
            __notifInitialized = true;
          }catch(e){
            console.warn('Error processing notifications snapshot', e);
            items = arr; cacheItems(); render(); updateGlobalUnreadCount();
            __notifInitialized = true;
          }
        }, err=>{ console.warn('notifications subscribe error', err); loadCachedAndRender(); });
      });

      function loadCachedAndRender(){ try{ const raw = localStorage.getItem('nuvia_notifications_cache'); if(raw){ items = JSON.parse(raw).map(c=>({...c, createdAt:new Date(c.createdAt)})); } }catch(e){} render(); }
      function cacheItems(){ try{ localStorage.setItem('nuvia_notifications_cache', JSON.stringify(items.map(i=>({...i, createdAt: i.createdAt.getTime()})))); }catch(e){} }
      function updateGlobalUnreadCount(){ try{ const count = items.filter(i=>i.unread).length; localStorage.setItem('nuvia_unread_count', String(count)); try{ if(typeof window.updateNotificationBadge === 'function'){ window.updateNotificationBadge(count); } else { const el = document.getElementById('notificationCount'); if (el) { if (count>0){ el.textContent = String(count); el.style.display='flex'; } else { el.style.display='none'; } } } }catch(_){} try{ window.dispatchEvent(new CustomEvent('nuvia:unreadChange',{ detail: count })); }catch(_){} }catch(e){} }

      // Provide a global fallback so other pages can update the header badge reliably
      try{
        if (!window.updateNotificationBadge || typeof window.updateNotificationBadge !== 'function'){
          window.updateNotificationBadge = function(count){ try{ const el = document.getElementById('notificationCount'); if(el){ if(Number(count) > 0){ el.textContent = String(count); el.style.display = 'flex'; } else { el.style.display = 'none'; } } localStorage.setItem('nuvia_unread_count', String(count)); }catch(_){} };
        }
      }catch(_){ }

      // Expose a small API for external scripts to interact with notifications UI
      try{ window.nuviaNotificationsApi = window.nuviaNotificationsApi || { refresh: ()=>{ render(); }, markAllRead: async ()=>{ await markAllAsRead(); } }; }catch(_){ }

      function syncUrl(){ try{ const u = new URL(window.location.href); if(currentTab && currentTab!=='all') u.searchParams.set('tab', currentTab); else u.searchParams.delete('tab'); const qv = (searchInput.value||'').trim(); if(qv) u.searchParams.set('q', qv); else u.searchParams.delete('q'); window.history.replaceState({}, '', u.toString()); }catch(_){} }
      function getCurrentFilteredItems(){ const q = (searchInput.value||'').toLowerCase().trim(); return items.filter(i=> (currentTab==='all' || i.type===currentTab) && (!q || (`${i.text} ${i.actor.name}`.toLowerCase().includes(q))) && !prefs.muted.includes(i.threadId) && !isSnoozed(i.threadId)); }

      function normalizeType(t){ const x = String(t||'').toLowerCase();
        if(['like','reaction','react','heart'].includes(x)) return 'likes';
        if(['comment','reply','replied','thread'].includes(x)) return 'comments';
        if(['mention','mentioned','ping'].includes(x)) return 'mentions';
        if(['tag','photo_tag','video_tag'].includes(x)) return 'tags';
        if(['share','repost','quote','quote_share'].includes(x)) return 'shares';
        if(['follow','connection','connect','friend_request','friend_accept'].includes(x)) return 'follows';
        if(['message','messages','dm'].includes(x)) return 'messages';
        if(['group','group_post','group_role','moderator'].includes(x)) return 'groups';
        if(['event','invite','invited','rsvp'].includes(x)) return 'events';
        if(['security','policy','system','admin','alert','reach','milestone','reminder','checkin','check-in','verification'].includes(x)) return 'system';
        return x || 'system';
      }

      function map(id, n){
        const ts = n.timestamp && typeof n.timestamp.toDate==='function' ? n.timestamp.toDate() : (n.timestamp? new Date(n.timestamp) : new Date());
        const norm = normalizeType(n.type || n.category || 'system');
        return {
          id,
          threadId: n.threadId || n.postId || (n.targetUrl? n.targetUrl : id),
          type: norm,
          actor:{name: n.senderUsername || n.actorName || 'System', profilePicId: n.senderProfilePhoto || n.senderProfilePicId || n.actorProfilePicId || null},
          text: n.message || n.text || '',
          createdAt: ts,
          unread: n.read===false || !n.read,
          meta: n.meta || {},
          mediaUrl: n.mediaUrl || null,
          raw: n
        }
      }

      function render(){
        const q = (searchInput.value||'').toLowerCase().trim();
        let filtered = items.slice();
        if(currentTab!=='all') filtered = filtered.filter(i=>i.type===currentTab);
        if(q) filtered = filtered.filter(i=>`${i.text} ${i.actor.name}`.toLowerCase().includes(q));
        filtered = filtered.filter(i=> !prefs.muted.includes(i.threadId) && !isSnoozed(i.threadId) );

        const threads = groupThreads(filtered);
        threads.sort((a,b)=>scoreThread(b)-scoreThread(a));

        updateTabCounts();
        feedEl.innerHTML='';
        if(threads.length===0){ emptyEl.style.display='block'; return; } else { emptyEl.style.display='none'; }

        const frag = document.createDocumentFragment();
        threads.forEach(t=>frag.appendChild(renderThread(t)));
        feedEl.appendChild(frag);
      }

      function groupThreads(list){
        const m = new Map();
        for(const it of list){ const k = it.threadId || it.id; if(!m.has(k)) m.set(k, {id:k, items:[], last:it}); m.get(k).items.push(it); if(!m.get(k).last || it.createdAt>m.get(k).last.createdAt) m.get(k).last = it; }
        return Array.from(m.values()).map(v=>({...v, count:v.items.length, unreadCount: v.items.filter(x=>x.unread).length}));
      }

      function scoreThread(t){
        const last = t.last;
        let s = (t.unreadCount||0) * 200;
        const typePriority = {mentions:150,message:140,messages:140,comments:120,follows:80,likes:40,shares:60,groups:50,events:50,system:20,tags:130};
        s += (typePriority[last.type]||20);
        const age = (Date.now()-last.createdAt.getTime())/1000; // seconds
        s += Math.max(0, 100 - Math.min(100, age/60));
        s += Math.min(50, t.count*6);
        return s;
      }

      function renderThread(t){
        const li = document.createElement('div'); li.className = `thread ${t.unreadCount? 'unread':''}`;
        const avatarCol = document.createElement('div'); avatarCol.className='avatar-col';
        const img = document.createElement('img'); img.className='avatar'; img.alt = (t.last.actor.name||'') + ' avatar';
        if(t.last.actor.profilePicId){ img.src = getCloudinaryImageUrl(t.last.actor.profilePicId, 'w_120,h_120,c_fill,g_face,r_max'); }
        else { img.src = `https://placehold.co/120x120/CCCCCC/000000?text=${encodeURIComponent((t.last.actor.name||'U').charAt(0))}` }
        avatarCol.appendChild(img);

        const content = document.createElement('div'); content.className='content';
        const head = document.createElement('div'); head.className='thread-header';
        const line = document.createElement('div'); line.className='actor-line';
        const name = document.createElement('span'); name.className='actor-name'; name.textContent = t.last.actor.name;
        const snippet = document.createElement('span'); snippet.className='actor-snippet'; snippet.textContent = ' ' + truncateText(t.last.text||'',80);
        line.appendChild(name); line.appendChild(snippet);
        head.appendChild(line);
        const meta = document.createElement('div'); meta.className='thread-meta';
        if(t.unreadCount>0) { const badge=document.createElement('div'); badge.className='priority-badge'; badge.textContent = `${t.unreadCount} new`; meta.appendChild(badge); }
        const time = document.createElement('div'); time.textContent = timeAgo(t.last.createdAt); meta.appendChild(time);
        head.appendChild(meta);

        const body = document.createElement('div'); body.className='thread-body';
        const msg = document.createElement('div'); msg.className='message'; msg.textContent = t.last.text || defaultTextFor(t.last.type, t.last.actor.name, t.last.raw);
        body.appendChild(msg);
        if(t.last.mediaUrl){ const thumb = document.createElement('img'); thumb.className='media-thumb'; thumb.src = t.last.mediaUrl; thumb.alt=''; body.appendChild(thumb); }
        content.appendChild(head); content.appendChild(body);

        const actions = document.createElement('div'); actions.className='thread-actions';
        const openBtn = document.createElement('button'); openBtn.className='action-btn primary'; openBtn.textContent = 'Open'; openBtn.addEventListener('click',()=>openThread(t));
        const replyBtn = document.createElement('button'); replyBtn.className='action-btn'; replyBtn.innerHTML = '<i class="fa-solid fa-reply"></i> Reply'; replyBtn.addEventListener('click',()=>openThread(t,'reply'));
        const moreBtn = document.createElement('button'); moreBtn.className='action-btn'; moreBtn.innerHTML = '<i class="fa-solid fa-ellipsis"></i>'; moreBtn.addEventListener('click',(e)=>openThreadMenu(e,t));
        actions.appendChild(openBtn); actions.appendChild(replyBtn); actions.appendChild(moreBtn);
        content.appendChild(actions);

        const expanded = document.createElement('div'); expanded.className='expanded-list';
        t.items.slice(0,6).forEach(it=>{
          const r = document.createElement('div'); r.className='item-small';
          const a = document.createElement('img'); a.className='avatar'; a.alt=''; a.src = it.actor.profilePicId? getCloudinaryImageUrl(it.actor.profilePicId,'w_80,h_80,c_fill,g_face,r_max') : `https://placehold.co/40x40/CCCCCC/000000?text=${encodeURIComponent((it.actor.name||'U').charAt(0))}`;
          const tx = document.createElement('div'); tx.className='item-text';
          const nm = document.createElement('div'); nm.className='item-name'; nm.textContent = it.actor.name || '';
          const mt = document.createElement('div'); mt.className='item-meta'; mt.textContent = `${truncateText(it.text,120)} · ${timeAgo(it.createdAt)}`;
          tx.appendChild(nm); tx.appendChild(mt);
          r.appendChild(a); r.appendChild(tx); expanded.appendChild(r);
        });
        content.appendChild(expanded);

        li.appendChild(avatarCol); li.appendChild(content);
        li.addEventListener('click',(e)=>{ if(e.target.closest('.action-btn')|| e.target.tagName==='BUTTON') return; li.classList.toggle('expanded'); });
        return li;
      }

      function openThread(t,mode){ if(mode==='reply'){ notify('Opening reply composer','info'); } else { const raw=t.last && t.last.raw || {}; if(raw && raw.targetUrl){ window.location.href = raw.targetUrl; } else if(t.last.type==='messages'){ if(raw.chatId){ window.location.href = `/chat.html?chatId=${encodeURIComponent(raw.chatId)}`; } else if(raw.partnerId){ window.location.href = `/chat.html?partnerId=${encodeURIComponent(raw.partnerId)}`; } else { notify('Opening messages','info'); } } else if(t.last.type==='groups' && raw.groupId){ window.location.href = `/group_chat.html?groupId=${encodeURIComponent(raw.groupId)}`; } else { notify('Opening thread','info'); } } markThreadRead(t); }
      async function markThreadRead(t){ t.items.forEach(it=>it.unread=false); render(); if(!currentUser) return; for(const it of t.items){ try{ await updateDoc(doc(db,'artifacts',appId,'users',currentUser.uid,'notifications', it.id), { read:true }); }catch(e){} } cacheItems(); updateGlobalUnreadCount(); }

      async function markAllAsRead(scope){ const toMark = (scope && scope.length? scope : items).filter(i=>i.unread); (scope && scope.length? scope : items).forEach(i=>i.unread=false); render(); if(!currentUser) return; for(const it of toMark){ try{ await updateDoc(doc(db,'artifacts',appId,'users',currentUser.uid,'notifications', it.id), { read:true }); }catch(e){} } cacheItems(); updateGlobalUnreadCount(); }

      function openThreadMenu(e,t){ e.stopPropagation();
        const menu = document.createElement('div'); menu.className='context-menu'; menu.style.top = (e.clientY)+'px';
        const m1 = document.createElement('div'); m1.className='context-item'; m1.textContent='Mute thread';
        const m2 = document.createElement('div'); m2.className='context-item'; m2.textContent='Snooze 1h';
        const m3 = document.createElement('div'); m3.className='context-item context-danger'; m3.textContent='Delete all';
        menu.appendChild(m1); menu.appendChild(m2); menu.appendChild(m3);
        document.body.appendChild(menu);
        const cleanup = ()=>{ try{ menu.remove(); document.removeEventListener('click',cleanup); }catch(_){} };
        setTimeout(()=>document.addEventListener('click',cleanup),0);
        m1.addEventListener('click',()=>{ prefs.muted.push(t.id); savePrefs(); cleanup(); render(); notify('Thread muted','info'); });
        m2.addEventListener('click',()=>{ prefs.snoozed = prefs.snoozed || {}; prefs.snoozed[t.id] = Date.now() + 60*60*1000; savePrefs(); cleanup(); render(); notify('Snoozed for 1 hour','info'); });
        m3.addEventListener('click', async ()=>{ cleanup(); if(!currentUser) return notify('Sign in to delete','error'); for(const it of t.items){ try{ await deleteDoc(doc(db,'artifacts',appId,'users',currentUser.uid,'notifications', it.id)); }catch(e){} } cacheItems(); updateGlobalUnreadCount(); notify('Deleted thread','success'); });
      }

      function truncateText(s,n){ if(!s) return ''; return s.length>n? s.slice(0,n-1)+'…': s; }
      function timeAgo(d){ const s=(Date.now()-new Date(d).getTime())/1000; if(s<60) return Math.floor(s)+'s'; const m=s/60; if(m<60) return Math.floor(m)+'m'; const h=m/60; if(h<24) return Math.floor(h)+'h'; const dd=h/24; if(dd<7) return Math.floor(dd)+'d'; const mo=dd/30; if(mo<12) return Math.floor(mo)+'mo'; return Math.floor(dd/365)+'y'; }
      function isSnoozed(threadId){ try{ const until = prefs && prefs.snoozed && prefs.snoozed[threadId]; return !!(until && Date.now() < until); }catch(_){ return false; } }

      async function fetchAndDisplayHeaderProfile(user){
        try{
          const publicRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid);
          const pubSnap = await getDoc(publicRef);
          let username = user.displayName || 'Grazzy User';
          let picId = user.photoURL || null;
          if (pubSnap.exists()){
            const d = pubSnap.data();
            if (d && d.username) username = d.username;
            if (d && (d.profilePicId || d.profilePhoto)) picId = d.profilePicId || d.profilePhoto;
          }
          const initial = (username || 'N').charAt(0).toUpperCase();
          if (headerProfilePic && headerAvatarIcon) displayProfilePicture(headerProfilePic, headerAvatarIcon, picId, initial, 'w_70,h_70,c_fill,g_face,r_max');
          if (headerDisplayName) headerDisplayName.textContent = username;
          if (profileLink) profileLink.href = `/profile.html?userId=${user.uid}`;
        }catch(e){
          const initial = (user.displayName || 'N').charAt(0).toUpperCase();
          if (headerProfilePic && headerAvatarIcon) displayProfilePicture(headerProfilePic, headerAvatarIcon, user.photoURL, initial, 'w_70,h_70,c_fill,g_face,r_max');
          if (headerDisplayName) headerDisplayName.textContent = user.displayName || 'Grazzy User';
        }
      }

      function defaultTextFor(type,name,raw){
        switch(type){
          case 'likes': return `${name} liked your post`;
          case 'comments': return `${name} commented on your post`;
          case 'mentions': return `${name} mentioned you`;
          case 'tags': return `${name} tagged you`;
          case 'follows': return `${name} started following you`;
          case 'shares': return `${name} shared your post`;
          case 'groups': return raw && raw.roleChange ? `${name} updated your group role` : `${name} posted in your group`;
          case 'events': return raw && raw.eventStatus ? `Event update: ${raw.eventStatus}` : `${name} invited you to an event`;
          case 'messages': return `${name} sent you a message`;
          case 'system': {
            const k = String(raw?.subtype||'').toLowerCase();
            if(['security','login','device'].includes(k)) return 'Security alert on your account';
            if(['reach','milestone','views','trending'].includes(k)) return 'Your content is gaining traction';
            if(['reminder','schedule','memory'].includes(k)) return 'Reminder';
            if(['policy','tos','update'].includes(k)) return 'Policy update';
            return 'System notification';
          }
          default: return 'Notification';
        }
      }

      let __notifAudio = null;
      function notify(msg, type='info'){
        try{ if (window.showMessageBox && typeof window.showMessageBox === 'function') { window.showMessageBox(msg, type); return; } }catch(_){ }
        toastEl.textContent = msg; toastEl.style.display = 'block'; setTimeout(()=>{ toastEl.style.display='none'; },2200);
        try{
          if (prefs.sound && !prefs.dnd){
            if (!__notifAudio) { __notifAudio = new Audio('ne.mp3'); __notifAudio.preload = 'auto'; __notifAudio.volume = 0.7; }
            __notifAudio.currentTime = 0;
            __notifAudio.play().catch(()=>{});
          }
        }catch(_){ }
      }

      function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); } }
      function updateTabCounts(){ try{
        const counts = items.reduce((acc,i)=>{ acc.all=(acc.all||0)+ (i.unread?1:0); acc[i.type]=(acc[i.type]||0)+ (i.unread?1:0); return acc; },{});
        tabs.forEach(tb=>{ const key = tb.dataset.tab; let badge = tb.querySelector('.tab-count'); if(!badge){ badge = document.createElement('span'); badge.className='tab-count'; tb.appendChild(badge); }
          const val = key==='all' ? (counts.all||0) : (counts[key]||0); if(val>0){ badge.textContent=String(val); badge.style.display='inline-block'; } else { badge.textContent=''; badge.style.display='none'; }
        });
      }catch(_){}}

      // initial load
      try{ const raw = localStorage.getItem('nuvia_notifications_cache'); if(raw) items = JSON.parse(raw).map(i=>({...i, createdAt:new Date(i.createdAt)})); }catch(e){}
      render();

    })();
  </script>
</body>
</html>
