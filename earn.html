<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Grazzy - Fun & Earn Arcade</title>
  <link rel="canonical" href="https://nuvia.app/earn.html">
  <meta name="theme-color" content="#1a1a2e">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
  <style>
    :root {
      --pink: #ff2e92;
      --blue: #00d5ff;
      --glass-black: rgba(10, 10, 10, .75);
      --glass-blue: rgba(0, 213, 255, .15);
      --radius: 20px;
      --transition: .3s ease;
      --white: #fff;
      --text-light: rgba(255, 255, 255, .7);
      --background-main: rgba(10, 10, 10, .75);
      --background-gradient-1: #00d5ff;
      --background-gradient-2: #ff2e92;
      --card-background: linear-gradient(145deg, rgba(255, 255, 255, .03), rgba(255, 255, 255, .01));
      --header-background: linear-gradient(135deg, rgba(10, 10, 10, .85), rgba(10, 10, 10, .75));
      --border-light: rgba(255, 255, 255, .05);
      --input-background: rgba(255, 255, 255, 0.05);
      --button-background: linear-gradient(90deg, var(--blue), var(--pink));
      --button-shadow: 0 4px 15px var(--blue), 0 4px 15px var(--pink);
      --background-color-primary: #1a1a2e;
      --background-color-secondary: #0f0f1f;
      --text-color-primary: #e0e0e0;
      --text-color-secondary: #b0b0d0;
    }
    *, *::before, *::after { box-sizing: border-box; }
    body { margin:0; font-family:'Inter', sans-serif; color: var(--white); background: radial-gradient(circle at top left, var(--background-gradient-1), transparent 100px), radial-gradient(circle at bottom right, var(--background-gradient-2), transparent 150px), linear-gradient(135deg, var(--background-color-primary), var(--background-color-secondary)); background-attachment: fixed; }
    header { background: var(--header-background); border-bottom: 1px solid var(--border-light); padding: 10px 0; position: sticky; top: 0; z-index: 10; }
    .header-content-wrapper { display:flex; align-items:center; justify-content:space-between; max-width:1200px; margin:0 auto; padding:0 20px; }
    .logo { font-family:'Poppins', sans-serif; font-weight:800; font-size:1.6rem; background-image: linear-gradient(90deg, var(--blue), var(--pink)); -webkit-background-clip: text; background-clip:text; color: transparent; text-decoration:none; }
    .home-chips-row { display:flex; gap:12px; align-items:center; }
    .chip { display:flex; gap:12px; align-items:center; min-width:180px; background: linear-gradient(180deg, rgba(19,20,40,0.9), rgba(19,20,40,0.8)); color:#fff !important; border-radius: 14px; padding: 12px 14px; border: 1px solid rgba(255,255,255,0.04); box-shadow: 0 8px 24px rgba(0,0,0,0.35); text-decoration:none; }
    .chip i { color: rgba(255,255,255,0.9); }
    .chip-text { display:flex; flex-direction:column; gap:6px; color:#fff !important; }
    #walletChipAmount { font-weight:800; font-size:1.05rem; color:#fff !important; }
    #jcoinRate { color:#fff !important; font-weight:700; }
    main { max-width:1200px; margin: 18px auto; padding: 0 20px 40px; }
    .noncash-banner { background: var(--card-background); border:1px solid var(--border-light); border-radius: 16px; padding: 12px 14px; color: var(--text-color-primary); display:flex; align-items:center; gap:10px; margin-bottom: 16px; }
    .noncash-banner i { color: var(--pink); }
    .grid { display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 14px; }
    @media (max-width: 1024px){ .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (max-width: 640px){ .grid{ grid-template-columns: 1fr; } }
    .engage-card { background: var(--card-background); border:1px solid var(--glass-blue); border-radius: 15px; padding: 12px; }
    .engage-title { font-weight:800; margin: 2px 0 8px; }
    .spin-button, .primary-btn, .ghost-btn { background: var(--button-background); color:#fff; border:none; border-radius:10px; padding:8px 12px; cursor:pointer; box-shadow: var(--button-shadow); font-weight:700; }
    .ghost-btn { background: transparent; border:1px solid var(--border-light); box-shadow:none; color: var(--white); }
    .muted { color: var(--text-light); font-size: .92rem; }
    .row { display:flex; align-items:center; justify-content:space-between; gap: 10px; }
    .quests-list { display:flex; flex-direction:column; gap:8px; }
    .quest-item { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .quest-progress { flex:1; height:8px; background:rgba(255,255,255,0.1); border-radius:6px; overflow:hidden; margin:0 8px; }
    .quest-progress > div { height:100%; background: var(--blue); }
    .tile-actions { display:flex; gap:10px; flex-wrap:wrap; }
    .action-link { display:inline-flex; align-items:center; gap:8px; text-decoration:none; font-weight:700; color:#fff; background: var(--button-background); border-radius:10px; padding:8px 12px; }
    .action-link.ghost { background: transparent; border:1px solid var(--border-light); }
    .earnings-footer { text-align:center; color: var(--text-light); margin-top: 16px; }
    .section-title { font-weight:800; font-size:1.2rem; margin: 16px 0 8px; }
    .hidden { display:none !important; }
    .align-start { align-items:flex-start; }
    .mt-4 { margin-top:4px; }
    .mt-8 { margin-top:8px; }
    .justify-end { justify-content:flex-end; }
    .modal-backdrop { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; backdrop-filter: blur(4px); background: rgba(0,0,0,0.35); z-index:1000; }
    .modal-card { width:min(520px, 92vw); }
    .quiz-options { display:grid; gap:8px; }
    .quiz-option { display:flex; align-items:center; gap:8px; cursor:pointer; }
  </style>
</head>
<body>
  <header>
    <div class="header-content-wrapper">
      <a class="logo" href="/index.html">Grazzy</a>
      <div class="home-chips-row">
        <a href="/wallet.html" id="walletChipLink" class="chip wallet-chip" aria-label="Open Wallet">
          <i class="fas fa-wallet"></i>
          <div class="chip-text">
            <div><span id="walletChipAmount">0</span> JCoins</div>
            <div class="chip-sub">Rate: ₦<span id="jcoinRate">0</span>/J</div>
          </div>
        </a>
      </div>
    </div>
  </header>
  <main>
    <div class="noncash-banner" role="note" aria-live="polite">
      <i class="fa-solid fa-heart" aria-hidden="true"></i>
      <div><strong>JCoin is not money.</strong> It can never be converted to real money. Earn for fun, and spend in groups on boosts, tickets, stickers, frames, and more.</div>
    </div>

    <h1 class="section-title">Fun & Earn Arcade</h1>
    <div class="grid" id="earnTiles">
      <div class="engage-card">
        <div class="engage-title">Daily Check‑in</div>
        <div class="row">
          <button id="checkInButton" class="primary-btn"><i class="fa-solid fa-calendar-check"></i> Check‑in</button>
          <div>
            <div id="checkInStatus" class="muted">Claim once per day.</div>
            <div id="streakLabel" class="muted mt-4">Streak: 0 days</div>
          </div>
        </div>
      </div>
      <div class="engage-card">
        <div class="engage-title">Daily Spin</div>
        <div class="row">
          <button class="spin-button" id="spinNowButton"><i class="fas fa-sync"></i> Spin Now</button>
          <div id="spinStatus" class="muted"></div>
        </div>
      </div>
      <div class="engage-card">
        <div class="engage-title">Weekly Quests</div>
        <div class="quests-list" id="questsList"></div>
      </div>
      <div class="engage-card">
        <div class="engage-title">Daily Trivia</div>
        <p class="muted">Answer 3 quick questions. Score 2+ to earn JCoins.</p>
        <div class="row">
          <button id="startQuizButton" class="primary-btn"><i class="fa-solid fa-circle-question"></i> Start Quiz</button>
          <div id="quizStatus" class="muted"></div>
        </div>
      </div>
      <div class="engage-card">
        <div class="engage-title">Scripture Memory</div>
        <div class="row align-start">
          <div style="flex:1;">
            <div id="memoryVerse" class="muted">Tap “Show Verse” to begin.</div>
            <div class="tile-actions mt-8">
              <button id="showVerseButton" class="ghost-btn"><i class="fa-solid fa-book-open"></i> Show Verse</button>
              <button id="markMemorizedButton" class="primary-btn"><i class="fa-solid fa-check-double"></i> Mark Memorized</button>
            </div>
          </div>
        </div>
      </div>
      <div class="engage-card">
        <div class="engage-title">Share Inspiration</div>
        <p class="muted">Post today’s quote or your custom message.</p>
        <div class="tile-actions">
          <a class="action-link" href="/index.html#inspiration"><i class="fa-solid fa-share"></i> Share / Post</a>
          <a class="action-link ghost" href="/index.html#inspiration"><i class="fa-solid fa-sliders"></i> Customize</a>
        </div>
      </div>
      <div class="engage-card">
        <div class="engage-title">Create a Post</div>
        <p class="muted">Write, add media or polls. Quality posts help your streaks and quests.</p>
        <div class="tile-actions">
          <a class="action-link" href="/index.html#postCreationSection"><i class="fa-solid fa-paper-plane"></i> Create Post</a>
        </div>
      </div>
      <div class="engage-card">
        <div class="engage-title">Bible/Quran Trivia</div>
        <p class="muted">Play short quizzes with friends and groups.</p>
        <div class="tile-actions">
          <a class="action-link" href="/bible.html"><i class="fa-solid fa-book-bible"></i> Bible Quiz</a>
          <a class="action-link ghost" href="/quran.html"><i class="fa-solid fa-moon"></i> Quran Quiz</a>
        </div>
      </div>
      <div class="engage-card">
        <div class="engage-title">Invite Friends</div>
        <p class="muted">Grow your circle. More friends, more fun.</p>
        <div class="tile-actions">
          <a class="action-link" href="/find_friends.html"><i class="fa-solid fa-user-plus"></i> Find Friends</a>
          <a class="action-link ghost" href="/friends.html"><i class="fa-solid fa-users"></i> Friends</a>
          <button id="copyInviteLinkButton" class="primary-btn"><i class="fa-solid fa-link"></i> Copy Invite Link</button>
        </div>
        <div id="inviteStatus" class="muted mt-8"></div>
      </div>
      <div class="engage-card">
        <div class="engage-title">Group Challenges</div>
        <p class="muted">Join group events and spend JCoins on boosts.</p>
        <div class="tile-actions">
          <a class="action-link" href="/groups.html"><i class="fa-solid fa-people-group"></i> Explore Groups</a>
          <a class="action-link ghost" href="/leaders_admin.html"><i class="fa-solid fa-ranking-star"></i> Leaderboards</a>
        </div>
      </div>
      <div class="engage-card">
        <div class="engage-title">Themes & Frames</div>
        <p class="muted">Spend JCoins on profile frames and premium looks.</p>
        <div class="tile-actions">
          <a class="action-link" href="/premium_themes.html"><i class="fa-solid fa-wand-magic-sparkles"></i> Themes</a>
          <a class="action-link ghost" href="/profile.html"><i class="fa-solid fa-id-badge"></i> My Profile</a>
        </div>
      </div>
      <div class="engage-card">
        <div class="engage-title">Scripture Reading</div>
        <p class="muted">Read a passage and reflect.</p>
        <div class="row">
          <button id="markReadButton" class="primary-btn"><i class="fa-solid fa-book"></i> Mark Read Today</button>
          <div id="readStatus" class="muted"></div>
        </div>
      </div>
      <div class="engage-card">
        <div class="engage-title">Reaction Rush</div>
        <p class="muted">10‑second tap challenge. Higher score, higher rewards.</p>
        <div class="row">
          <button id="playRushButton" class="primary-btn"><i class="fa-solid fa-bolt"></i> Play 10s Rush</button>
          <div id="rushStatus" class="muted"></div>
        </div>
      </div>
      <div class="engage-card">
        <div class="engage-title">Weekly Streak Bonus</div>
        <p class="muted">Maintain 7‑day check‑in streak to claim weekly bonus.</p>
        <div class="row">
          <button id="claimWeeklyStreakButton" class="primary-btn"><i class="fa-solid fa-calendar-week"></i> Claim Weekly</button>
          <div id="weeklyStreakStatus" class="muted"></div>
        </div>
      </div>

      <div class="engage-card">
        <div class="engage-title">Hard Quiz (5 Q)</div>
        <p class="muted">Score 4+ correct for rewards. One attempt per day.</p>
        <div class="row">
          <button id="startHardQuizButton" class="primary-btn"><i class="fa-solid fa-brain"></i> Start Hard Quiz</button>
          <div id="hardQuizStatus" class="muted"></div>
        </div>
      </div>

      <div class="engage-card">
        <div class="engage-title">Focus Timer</div>
        <p class="muted">Stay focused for 2 minutes without leaving or minimizing.</p>
        <div class="row">
          <button id="startFocusButton" class="primary-btn"><i class="fa-solid fa-hourglass"></i> Start 2‑min Focus</button>
          <div id="focusStatus" class="muted"></div>
        </div>
      </div>

      <div class="engage-card">
        <div class="engage-title">Typing Challenge</div>
        <p class="muted">Type the passage with 95%+ accuracy in 60s.</p>
        <div class="row">
          <button id="startTypingButton" class="primary-btn"><i class="fa-solid fa-keyboard"></i> Begin</button>
          <div id="typingStatus" class="muted"></div>
        </div>
      </div>

      <div class="engage-card">
        <div class="engage-title">Math Blitz</div>
        <p class="muted">30s. Answer 10 rapid questions. Get 8+ correct to win.</p>
        <div class="row">
          <button id="startMathBlitzButton" class="primary-btn"><i class="fa-solid fa-calculator"></i> Start Blitz</button>
          <div id="mathBlitzStatus" class="muted"></div>
        </div>
      </div>

      <div class="engage-card">
        <div class="engage-title">Word Unscramble</div>
        <p class="muted">45s. Unscramble the word correctly.</p>
        <div class="row">
          <button id="startScrambleButton" class="primary-btn"><i class="fa-solid fa-font"></i> Start</button>
          <div id="scrambleStatus" class="muted"></div>
        </div>
      </div>

      <div class="engage-card">
        <div class="engage-title">Memory Match</div>
        <p class="muted">Match all pairs within 60s.</p>
        <div class="row">
          <button id="startMemoryButton" class="primary-btn"><i class="fa-solid fa-brain"></i> Play</button>
          <div id="memoryStatus" class="muted"></div>
        </div>
      </div>
    </div>

    <div class="earnings-footer">
      View balances and history in <a href="/wallet.html" style="color:var(--blue); font-weight:800; text-decoration:none;">Wallet</a>.
    </div>
    <h2 class="section-title">Recent Earnings</h2>
    <div class="engage-card" id="earningsCard">
      <div id="earningsList" class="quests-list"></div>
    </div>
  </main>

  <div id="toast" class="hidden" style="position:fixed; bottom:16px; left:50%; transform:translateX(-50%); background:var(--card-background); border:1px solid var(--border-light); color:var(--white); padding:10px 12px; border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,0.35); z-index:9999;"></div>

  <div id="quizModal" class="hidden modal-backdrop">
    <div class="engage-card modal-card">
      <div class="engage-title">Daily Trivia</div>
      <div id="quizContent" class="muted"></div>
      <div class="tile-actions mt-8 justify-end">
        <button id="quizNextButton" class="primary-btn"><i class="fa-solid fa-arrow-right"></i> Next</button>
        <button id="quizCloseButton" class="ghost-btn"><i class="fa-solid fa-xmark"></i> Close</button>
      </div>
    </div>
  </div>
  <div id="rushModal" class="hidden modal-backdrop">
    <div class="engage-card modal-card">
      <div class="engage-title">Reaction Rush</div>
      <div id="rushContent" class="muted"></div>
      <div class="tile-actions mt-8 justify-end">
        <button id="rushStartButton" class="primary-btn"><i class="fa-solid fa-play"></i> Start</button>
        <button id="rushCloseButton" class="ghost-btn"><i class="fa-solid fa-xmark"></i> Close</button>
      </div>
    </div>
  </div>
  <div id="hardQuizModal" class="hidden modal-backdrop">
    <div class="engage-card modal-card">
      <div class="engage-title">Hard Quiz</div>
      <div id="hardQuizContent" class="muted"></div>
      <div class="tile-actions mt-8 justify-end">
        <button id="hardQuizNextButton" class="primary-btn"><i class="fa-solid fa-arrow-right"></i> Next</button>
        <button id="hardQuizCloseButton" class="ghost-btn"><i class="fa-solid fa-xmark"></i> Close</button>
      </div>
    </div>
  </div>
  <div id="focusModal" class="hidden modal-backdrop">
    <div class="engage-card modal-card">
      <div class="engage-title">Focus Timer</div>
      <div id="focusContent" class="muted"></div>
      <div class="tile-actions mt-8 justify-end">
        <button id="focusCloseButton" class="ghost-btn"><i class="fa-solid fa-xmark"></i> Close</button>
      </div>
    </div>
  </div>
  <div id="typingModal" class="hidden modal-backdrop">
    <div class="engage-card modal-card">
      <div class="engage-title">Typing Challenge</div>
      <div id="typingContent" class="muted"></div>
      <div class="tile-actions mt-8 justify-end">
        <button id="typingSubmitButton" class="primary-btn"><i class="fa-solid fa-paper-plane"></i> Submit</button>
        <button id="typingCloseButton" class="ghost-btn"><i class="fa-solid fa-xmark"></i> Close</button>
      </div>
    </div>
  </div>

  <div id="mathBlitzModal" class="hidden modal-backdrop">
    <div class="engage-card modal-card">
      <div class="engage-title">Math Blitz</div>
      <div id="mathBlitzContent" class="muted"></div>
      <div class="tile-actions mt-8 justify-end">
        <button id="mathBlitzNextButton" class="primary-btn"><i class="fa-solid fa-arrow-right"></i> Next</button>
        <button id="mathBlitzCloseButton" class="ghost-btn"><i class="fa-solid fa-xmark"></i> Close</button>
      </div>
    </div>
  </div>

  <div id="scrambleModal" class="hidden modal-backdrop">
    <div class="engage-card modal-card">
      <div class="engage-title">Word Unscramble</div>
      <div id="scrambleContent" class="muted"></div>
      <div class="tile-actions mt-8 justify-end">
        <button id="scrambleSubmitButton" class="primary-btn"><i class="fa-solid fa-paper-plane"></i> Submit</button>
        <button id="scrambleCloseButton" class="ghost-btn"><i class="fa-solid fa-xmark"></i> Close</button>
      </div>
    </div>
  </div>

  <div id="memoryModal" class="hidden modal-backdrop">
    <div class="engage-card modal-card">
      <div class="engage-title">Memory Match</div>
      <div id="memoryContent" class="muted"></div>
      <div class="tile-actions mt-8 justify-end">
        <button id="memoryCloseButton" class="ghost-btn"><i class="fa-solid fa-xmark"></i> Close</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-auth.js";
    import { initializeFirestore, doc, getDoc, setDoc, updateDoc, runTransaction, serverTimestamp, collection, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-firestore.js";

    const firebaseConfig = typeof window.__firebase_config !== 'undefined' ? JSON.parse(window.__firebase_config) : {
      apiKey: "AIzaSyAm8ghbQ_lwJdNXEhWGos0eyi5wtvGuRR4",
      authDomain: "grazzy-9e736.firebaseapp.com",
      databaseURL: "https://grazzy-9e736-default-rtdb.firebaseio.com",
      projectId: "grazzy-9e736",
      storageBucket: "grazzy-9e736.firebasestorage.app",
      messagingSenderId: "750326949170",
      appId: "1:750326949170:web:5d19744aafc8675918632b"
    };
    const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';

    const app = initializeApp(firebaseConfig);
    const db = initializeFirestore(app, {});
    const auth = getAuth(app);

    const walletChipAmount = document.getElementById('walletChipAmount');
    const jcoinRateSpan = document.getElementById('jcoinRate');
    const checkInButton = document.getElementById('checkInButton');
    const checkInStatus = document.getElementById('checkInStatus');
    const spinNowButton = document.getElementById('spinNowButton');
    const spinStatus = document.getElementById('spinStatus');
    const questsList = document.getElementById('questsList');
    const streakLabel = document.getElementById('streakLabel');
    const startQuizButton = document.getElementById('startQuizButton');
    const quizStatus = document.getElementById('quizStatus');
    const quizModal = document.getElementById('quizModal');
    const quizContent = document.getElementById('quizContent');
    const quizNextButton = document.getElementById('quizNextButton');
    const quizCloseButton = document.getElementById('quizCloseButton');
    const showVerseButton = document.getElementById('showVerseButton');
    const markMemorizedButton = document.getElementById('markMemorizedButton');
    const memoryVerseEl = document.getElementById('memoryVerse');
    const earningsList = document.getElementById('earningsList');
    const copyInviteLinkButton = document.getElementById('copyInviteLinkButton');
    const inviteStatus = document.getElementById('inviteStatus');
    const markReadButton = document.getElementById('markReadButton');
    const readStatus = document.getElementById('readStatus');
    const playRushButton = document.getElementById('playRushButton');
    const rushStatus = document.getElementById('rushStatus');
    const rushModal = document.getElementById('rushModal');
    const rushContent = document.getElementById('rushContent');
    const rushStartButton = document.getElementById('rushStartButton');
    const rushCloseButton = document.getElementById('rushCloseButton');
    const claimWeeklyStreakButton = document.getElementById('claimWeeklyStreakButton');
    const weeklyStreakStatus = document.getElementById('weeklyStreakStatus');

    // New DOM refs for challenging activities
    const startHardQuizButton = document.getElementById('startHardQuizButton');
    const hardQuizStatus = document.getElementById('hardQuizStatus');
    const hardQuizModal = document.getElementById('hardQuizModal');
    const hardQuizContent = document.getElementById('hardQuizContent');
    const hardQuizNextButton = document.getElementById('hardQuizNextButton');
    const hardQuizCloseButton = document.getElementById('hardQuizCloseButton');

    const startFocusButton = document.getElementById('startFocusButton');
    const focusStatus = document.getElementById('focusStatus');
    const focusModal = document.getElementById('focusModal');
    const focusContent = document.getElementById('focusContent');
    const focusCloseButton = document.getElementById('focusCloseButton');

    const startTypingButton = document.getElementById('startTypingButton');
    const typingStatus = document.getElementById('typingStatus');
    const typingModal = document.getElementById('typingModal');
    const typingContent = document.getElementById('typingContent');
    const typingSubmitButton = document.getElementById('typingSubmitButton');
    const typingCloseButton = document.getElementById('typingCloseButton');

    // Math Blitz
    const startMathBlitzButton = document.getElementById('startMathBlitzButton');
    const mathBlitzStatus = document.getElementById('mathBlitzStatus');
    const mathBlitzModal = document.getElementById('mathBlitzModal');
    const mathBlitzContent = document.getElementById('mathBlitzContent');
    const mathBlitzNextButton = document.getElementById('mathBlitzNextButton');
    const mathBlitzCloseButton = document.getElementById('mathBlitzCloseButton');

    // Word Scramble
    const startScrambleButton = document.getElementById('startScrambleButton');
    const scrambleStatus = document.getElementById('scrambleStatus');
    const scrambleModal = document.getElementById('scrambleModal');
    const scrambleContent = document.getElementById('scrambleContent');
    const scrambleSubmitButton = document.getElementById('scrambleSubmitButton');
    const scrambleCloseButton = document.getElementById('scrambleCloseButton');

    // Memory Match
    const startMemoryButton = document.getElementById('startMemoryButton');
    const memoryStatus = document.getElementById('memoryStatus');
    const memoryModal = document.getElementById('memoryModal');
    const memoryContent = document.getElementById('memoryContent');
    const memoryCloseButton = document.getElementById('memoryCloseButton');

    let currentUser = null;
    let currentUserProfileData = null;
    let quizIndex = 0;
    let quizCorrect = 0;
    let rushClicks = 0;
    let rushTimer = null;
    // Hard quiz state
    let hardQuizIndex = 0;
    let hardQuizCorrect = 0;
    // Focus timer state
    let focusTimer = null;
    let focusRemaining = 0;
    let focusFailed = false;
    // Typing challenge state
    let typingStartAt = 0;
    let typingTarget = '';
    // Math Blitz state
    let blitzTimer = null; let blitzTimeLeft = 0; let blitzIndex = 0; let blitzCorrect = 0; let blitzStartedAt = 0;
    // Scramble state
    let scrambleWord = ''; let scrambleTimer = null; let scrambleTimeLeft = 0;
    // Memory match state
    let memoryCards = []; let memoryFlipped = []; let memoryMatched = 0; let memoryTimer = null; let memoryTimeLeft = 0; let memoryLocked = false;

    const quizQuestions = [
      { q: 'Which book comes first?', a: ['Genesis','Exodus','Leviticus','Numbers'], c: 0 },
      { q: 'How many surahs are in the Quran?', a: ['100','102','112','114'], c: 3 },
      { q: 'Which is a gospel writer?', a: ['Paul','David','Luke','Moses'], c: 2 }
    ];
    const hardQuizQuestions = [
      { q: 'Longest chapter in the Bible?', a: ['Psalm 117','Psalm 119','Psalm 23','Psalm 1'], c: 1 },
      { q: 'How many books in the Bible?', a: ['60','66','72','64'], c: 1 },
      { q: 'First revealed word in Quran?', a: ['Iqra','Bismillah','Allahu','Alif'], c: 0 },
      { q: 'Who built the Kaaba with Ibrahim?', a: ['Musa','Ismail','Isa','Yusuf'], c: 1 },
      { q: 'Gospel also called?', a: ['Torah','Zabur','Injil','Hadith'], c: 2 }
    ];
    const verses = [
      '“The Lord is my shepherd; I shall not want.” — Psalm 23:1',
      '“Indeed, with hardship [will be] ease.” — Quran 94:6',
      '“Be still, and know that I am God.” — Psalm 46:10',
      '“And whoever relies upon Allah — then He is sufficient for him.” — Quran 65:3'
    ];

    function showToast(msg){ const t = document.getElementById('toast'); if(!t) return; t.textContent = msg; t.classList.remove('hidden'); clearTimeout(t._h); t._h = setTimeout(()=> t.classList.add('hidden'), 2200); }

    async function loadProfileAndWallet(uid){
      try {
        const profileRef = doc(db, 'artifacts', appId, 'users', uid, 'profiles', 'user_profile');
        const snap = await getDoc(profileRef);
        if (snap.exists()) {
          currentUserProfileData = snap.data();
          const j = Number(currentUserProfileData?.jCoins || 0);
          if (walletChipAmount) walletChipAmount.textContent = String(j);
          const computedRate = (j * 0.005).toFixed(3);
          if (jcoinRateSpan) jcoinRateSpan.textContent = computedRate;
        }
      } catch(e){ console.error(e); }
    }

    function fmtDateUTC(d){ const y=d.getUTCFullYear(); const m=String(d.getUTCMonth()+1).padStart(2,'0'); const dd=String(d.getUTCDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; }

    async function awardJCoins(amount, reason, meta={}){
      if (!currentUser) return false;
      const profileRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profiles', 'user_profile');
      const logRef = doc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'earnings'));
      try{
        await runTransaction(db, async (trx)=>{
          const ps = await trx.get(profileRef);
          const cur = ps.exists()? (ps.data().jCoins||0):0;
          if (!ps.exists()) trx.set(profileRef, { jCoins: 0 }, { merge: true });
          trx.update(profileRef, { jCoins: cur + amount, lifetimeEarned: (ps.data()?.lifetimeEarned||0) + amount, updatedAt: serverTimestamp() });
        });
        await setDoc(logRef, { type: reason, amount, ts: serverTimestamp(), ...meta });
        await loadProfileAndWallet(currentUser.uid);
        return true;
      }catch(e){ console.error(e); return false; }
    }

    async function awardGas(amount, reason, meta={}){
      if (!currentUser) return false;
      const profileRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profiles', 'user_profile');
      const xpLogRef = doc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'xp_logs'));
      try{
        await runTransaction(db, async (trx)=>{
          const ps = await trx.get(profileRef);
          const curGas = ps.exists()? (ps.data().gas||0):0;
          const totalGas = ps.exists()? (ps.data().totalGasEarned||0):0;
          if (!ps.exists()) trx.set(profileRef, { gas: 0, totalGasEarned: 0 }, { merge: true });
          trx.update(profileRef, { gas: curGas + amount, totalGasEarned: totalGas + amount, updatedAt: serverTimestamp() });
        });
        await setDoc(xpLogRef, { type: reason, amount, ts: serverTimestamp(), ...meta });
        return true;
      }catch(e){ console.error(e); return false; }
    }

    async function loadEarningsHistory(){
      if (!currentUser || !earningsList) return;
      earningsList.innerHTML = '';
      try{
        const qy = query(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'earnings'), orderBy('ts','desc'));
        const snap = await getDocs(qy);
        if (snap.empty){ earningsList.innerHTML = '<div class="muted">No earnings yet.</div>'; return; }
        snap.docs.slice(0,10).forEach(d=>{
          const it = d.data();
          const row = document.createElement('div');
          row.className = 'quest-item';
          const amt = typeof it.amount==='number' ? `+${it.amount} J` : '';
          const when = it.ts?.toDate ? it.ts.toDate() : new Date();
          row.innerHTML = `<span>${it.type||'Earning'}</span><span class="muted">${when.toLocaleString()}</span><span style="font-weight:800;">${amt}</span>`;
          earningsList.appendChild(row);
        });
      }catch(e){ console.error(e); }
    }

    function renderQuests(){
      if (!questsList) return;
      questsList.innerHTML = '';
      const weekQuests = [
        { id:'q1', title:'React 10 times', target:10, progress:0 },
        { id:'q2', title:'Comment 5 times', target:5, progress:0 },
        { id:'q3', title:'Create 2 posts', target:2, progress:0 }
      ];
      weekQuests.forEach(q=>{
        const pct = Math.min(100, Math.round((q.progress/q.target)*100));
        const row = document.createElement('div');
        row.className = 'quest-item';
        row.innerHTML = `<span>${q.title}</span><div class="quest-progress"><div style="width:${pct}%"></div></div><span>${q.progress}/${q.target}</span>`;
        questsList.appendChild(row);
      });
    }

    async function refreshStreakUI(){
      if (!currentUser || !streakLabel) return;
      try{
        const ref = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'engagement', 'daily_checkin');
        const snap = await getDoc(ref);
        if (snap.exists()){
          const data = snap.data();
          const sc = data.streakCount || 0;
          streakLabel.textContent = `Streak: ${sc} day${sc===1?'':'s'}`;
        }
      }catch(e){ console.error(e); }
    }

    async function handleCheckIn(){
      if (!currentUser) { showToast('Login to check‑in.'); return; }
      const ref = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'engagement', 'daily_checkin');
      const snap = await getDoc(ref);
      const now = new Date();
      const todayStr = fmtDateUTC(now);
      let prevStr = null; let streak = 0; let lastDate = null;
      if (snap.exists()) {
        const data = snap.data();
        lastDate = data.lastAt?.toDate() || null;
        prevStr = data.lastDateStr || null;
        if (lastDate) {
          const since = now - lastDate;
          if (since < 24*60*60*1000) {
            const hrs = Math.ceil((24*60*60*1000 - since)/3600000);
            if (checkInStatus) checkInStatus.textContent = `Come back in ~${hrs}h.`;
            return;
          }
        }
        streak = data.streakCount || 0;
      }
      try {
        const yesterday = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()-1));
        const yStr = fmtDateUTC(yesterday);
        const newStreak = prevStr === yStr ? (streak+1) : 1;
        const ok = await awardJCoins(10, 'daily_checkin');
        if (!ok) throw new Error('award failed');
        await setDoc(ref, { lastAt: serverTimestamp(), lastDateStr: todayStr, streakCount: newStreak }, { merge: true });
        if (checkInStatus) checkInStatus.textContent = `Checked‑in! +10 JCoins`;
        if (streakLabel) streakLabel.textContent = `Streak: ${newStreak} day${newStreak===1?'':'s'}`;
      } catch(e){ console.error(e); showToast('Check‑in failed.'); }
    }

    async function handleSpin(){
      if (!currentUser) { showToast('Login to spin.'); return; }
      const spinRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'engagement', 'daily_spin');
      const snap = await getDoc(spinRef);
      const now = new Date();
      if (snap.exists()) {
        const last = snap.data().lastSpinAt?.toDate();
        if (last) {
          const since = now - last;
          if (since < 24*60*60*1000) {
            const hrs = Math.ceil((24*60*60*1000 - since)/3600000);
            if (spinStatus) spinStatus.textContent = `Come back in ~${hrs}h.`;
            return;
          }
        }
      }
      const rewards = [ {j:5, w:40}, {j:10, w:30}, {j:20, w:20}, {j:50, w:8}, {j:100, w:2} ];
      const totalW = rewards.reduce((a,b)=>a+b.w,0);
      let r = Math.random()*totalW, pick = rewards[0];
      for (const it of rewards) { if (r < it.w) { pick = it; break; } r -= it.w; }
      try {
        const ok = await awardJCoins(pick.j, 'daily_spin', { prize: pick.j });
        if (!ok) throw new Error('award failed');
        await setDoc(spinRef, { lastSpinAt: serverTimestamp() }, { merge: true });
        if (spinStatus) spinStatus.textContent = `You won ${pick.j} JCoins!`;
      } catch(e){ console.error(e); showToast('Spin failed.'); }
    }

    function openQuiz(){ if (quizModal) quizModal.classList.remove('hidden'); renderQuizStep(); }
    function closeQuiz(){ if (quizModal) quizModal.classList.add('hidden'); }
    function renderQuizStep(){
      if (!quizContent) return;
      const q = quizQuestions[quizIndex];
      let html = `<div style="font-weight:800; margin-bottom:8px;">Q${quizIndex+1}/3: ${q.q}</div>`;
      html += '<div class="quiz-options">';
      q.a.forEach((opt, i)=>{
        html += `<label class="quiz-option">
          <input type="radio" name="quizOpt" value="${i}"> <span>${opt}</span>
        </label>`;
      });
      html += '</div>';
      quizContent.innerHTML = html;
    }

    function openHardQuiz(){ if (hardQuizModal) hardQuizModal.classList.remove('hidden'); renderHardQuizStep(); }
    function closeHardQuiz(){ if (hardQuizModal) hardQuizModal.classList.add('hidden'); }
    function renderHardQuizStep(){
      if (!hardQuizContent) return;
      const q = hardQuizQuestions[hardQuizIndex];
      let html = `<div style="font-weight:800; margin-bottom:8px;">Q${hardQuizIndex+1}/5: ${q.q}</div>`;
      html += '<div class="quiz-options">';
      q.a.forEach((opt, i)=>{
        html += `<label class="quiz-option">
          <input type="radio" name="hardQuizOpt" value="${i}"> <span>${opt}</span>
        </label>`;
      });
      html += '</div>';
      hardQuizContent.innerHTML = html;
    }

    async function nextHardQuizStep(){
      const sel = hardQuizContent.querySelector('input[name="hardQuizOpt"]:checked');
      if (!sel) { showToast('Choose an answer'); return; }
      const val = Number(sel.value);
      if (val === hardQuizQuestions[hardQuizIndex].c) hardQuizCorrect++;
      hardQuizIndex++;
      if (hardQuizIndex >= hardQuizQuestions.length){
        closeHardQuiz();
        if (!currentUser){ showToast('Login to play.'); return; }
        const ref = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'engagement', 'daily_hard_quiz');
        const snap = await getDoc(ref);
        const now = new Date();
        if (snap.exists()){
          const last = snap.data().lastAt?.toDate();
          if (last && (now - last) < 24*60*60*1000){ hardQuizStatus.textContent = 'Come back tomorrow.'; hardQuizIndex = 0; hardQuizCorrect = 0; return; }
        }
        if (hardQuizCorrect >= 4){
          const okJ = await awardJCoins(25, 'hard_quiz', { correct: hardQuizCorrect });
          const okG = await awardGas(40, 'hard_quiz', { correct: hardQuizCorrect });
          if (okJ && okG){ hardQuizStatus.textContent = `Passed ${hardQuizCorrect}/5. +25 J, +40 Gas`; await setDoc(ref, { lastAt: serverTimestamp() }, { merge: true }); }
          await loadEarningsHistory();
        } else {
          hardQuizStatus.textContent = `Score ${hardQuizCorrect}/5. Try again tomorrow.`;
          await setDoc(ref, { lastAt: serverTimestamp() }, { merge: true });
        }
        hardQuizIndex = 0; hardQuizCorrect = 0;
        return;
      }
      renderHardQuizStep();
    }

    async function nextQuizStep(){
      const sel = quizContent.querySelector('input[name="quizOpt"]:checked');
      if (!sel) { showToast('Choose an answer'); return; }
      const val = Number(sel.value);
      if (val === quizQuestions[quizIndex].c) quizCorrect++;
      quizIndex++;
      if (quizIndex >= quizQuestions.length){
        closeQuiz();
        // gate daily
        if (!currentUser) { showToast('Login to play.'); return; }
        const ref = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'engagement', 'daily_quiz');
        const snap = await getDoc(ref);
        const now = new Date();
        if (snap.exists()){
          const last = snap.data().lastAt?.toDate();
          if (last && (now - last) < 24*60*60*1000){ quizStatus.textContent = 'Come back tomorrow.'; return; }
        }
        const passed = quizCorrect >= 2;
        if (passed){
          const ok = await awardJCoins(15, 'daily_quiz', { correct: quizCorrect });
          if (ok){ quizStatus.textContent = `Great! +15 JCoins (Score ${quizCorrect}/3)`; await setDoc(ref, { lastAt: serverTimestamp() }, { merge: true }); }
          else { showToast('Could not award.'); }
        } else {
          quizStatus.textContent = `Score ${quizCorrect}/3. Try again tomorrow.`;
          await setDoc(ref, { lastAt: serverTimestamp() }, { merge: true });
        }
        quizIndex = 0; quizCorrect = 0;
        await loadEarningsHistory();
        return;
      }
      renderQuizStep();
    }

    function showRandomVerse(){
      const v = verses[Math.floor(Math.random()*verses.length)];
      if (memoryVerseEl) memoryVerseEl.textContent = v;
    }

    async function copyInviteLink(){
      if (!currentUser){ showToast('Login first.'); return; }
      const link = `${location.origin}/index.html?ref=${currentUser.uid}`;
      try{ await navigator.clipboard.writeText(link); }catch(e){ console.error(e); }
      const todayStr = fmtDateUTC(new Date());
      const ref = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'engagement', 'daily_invite');
      const snap = await getDoc(ref);
      let count = 0; let lastDateStr = null;
      if (snap.exists()){ count = snap.data().count||0; lastDateStr = snap.data().dateStr||null; }
      if (lastDateStr === todayStr && count >= 3){ if (inviteStatus) inviteStatus.textContent = 'Daily limit reached.'; return; }
      const newCount = (lastDateStr === todayStr ? count : 0) + 1;
      const ok = await awardJCoins(2, 'invite_share');
      if (ok){ await setDoc(ref, { dateStr: todayStr, count: newCount, lastAt: serverTimestamp() }, { merge: true }); if (inviteStatus) inviteStatus.textContent = `Shared! ${newCount}/3 today (+2 JCoins)`; }
      await loadEarningsHistory();
    }

    async function markMemorized(){
      if (!currentUser) { showToast('Login first.'); return; }
      const ref = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'engagement', 'daily_memory');
      const snap = await getDoc(ref);
      const now = new Date();
      if (snap.exists()){
        const last = snap.data().lastAt?.toDate();
        if (last && (now - last) < 24*60*60*1000){ showToast('Come back tomorrow.'); return; }
      }
      const ok = await awardJCoins(10, 'daily_memory');
      if (ok){ await setDoc(ref, { lastAt: serverTimestamp() }, { merge: true }); showToast('Nice! +10 JCoins'); }
      await loadEarningsHistory();
    }

    function openRush(){ if (rushModal) rushModal.classList.remove('hidden'); rushContent.innerHTML = '<div class="muted">Tap Start, then tap as fast as you can!</div>'; }
    function closeRush(){ if (rushModal) rushModal.classList.add('hidden'); stopRush(); }
    function stopRush(){ if (rushTimer){ clearTimeout(rushTimer); rushTimer=null; } document.removeEventListener('click', rushTapHandler, true); }
    function rushTapHandler(e){ if (!rushTimer) return; if (e.target && e.target.id === 'rushTapButton'){ rushClicks++; const c = document.getElementById('rushCount'); if (c) c.textContent = String(rushClicks); } }

    async function startRush(){
      if (!currentUser){ showToast('Login first.'); return; }
      // daily gate
      const ref = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'engagement', 'daily_rush');
      const snap = await getDoc(ref);
      const now = new Date();
      if (snap.exists()){
        const last = snap.data().lastAt?.toDate();
        if (last && (now - last) < 24*60*60*1000){ rushStatus.textContent = 'Come back tomorrow.'; return; }
      }
      rushClicks = 0;
      rushContent.innerHTML = '<div style="font-weight:800;">10s Rush</div><div class="muted">Taps: <span id="rushCount">0</span></div><div class="tile-actions mt-8"><button id="rushTapButton" class="primary-btn"><i class="fa-solid fa-hand-pointer"></i> Tap!</button></div>';
      document.addEventListener('click', rushTapHandler, true);
      if (rushTimer) clearTimeout(rushTimer);
      rushTimer = setTimeout(async ()=>{
        stopRush();
        closeRush();
        let jReward = 5; if (rushClicks >= 30) jReward = 20; else if (rushClicks >= 15) jReward = 10;
        let gReward = 5; if (rushClicks >= 30) gReward = 20; else if (rushClicks >= 15) gReward = 10;
        const okJ = await awardJCoins(jReward, 'daily_rush', { clicks: rushClicks });
        const okG = await awardGas(gReward, 'daily_rush', { clicks: rushClicks });
        if (okJ && okG){ rushStatus.textContent = `Score ${rushClicks}. +${jReward} J, +${gReward} Gas`; await setDoc(ref, { lastAt: serverTimestamp() }, { merge: true }); }
        await loadEarningsHistory();
      }, 10000);
    }

    async function markReadToday(){
      if (!currentUser){ showToast('Login first.'); return; }
      const ref = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'engagement', 'daily_read');
      const snap = await getDoc(ref);
      const now = new Date();
      if (snap.exists()){
        const last = snap.data().lastAt?.toDate();
        if (last && (now - last) < 24*60*60*1000){ if (readStatus) readStatus.textContent = 'Already marked today.'; return; }
      }
      const ok = await awardJCoins(5, 'daily_read');
      if (ok){ await setDoc(ref, { lastAt: serverTimestamp() }, { merge: true }); if (readStatus) readStatus.textContent = 'Nice! +5 JCoins'; }
      await loadEarningsHistory();
    }

    function getISOWeek(d){ const date=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate())); const dayNum=(date.getUTCDay()||7); date.setUTCDate(date.getUTCDate()+4-dayNum); const yearStart=new Date(Date.UTC(date.getUTCFullYear(),0,1)); const weekNo=Math.ceil((((date-yearStart)/86400000)+1)/7); return `${date.getUTCFullYear()}-W${String(weekNo).padStart(2,'0')}`; }

    async function claimWeeklyStreak(){
      if (!currentUser){ showToast('Login first.'); return; }
      const weekStr = getISOWeek(new Date());
      const bonusRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'engagement', 'weekly_streak_bonus');
      const bonusSnap = await getDoc(bonusRef);
      if (bonusSnap.exists() && bonusSnap.data().lastWeekStr === weekStr){ weeklyStreakStatus.textContent = 'Already claimed this week.'; return; }
      // need streak >= 7
      const checkinRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'engagement', 'daily_checkin');
      const cs = await getDoc(checkinRef);
      const streak = cs.exists()? (cs.data().streakCount||0) : 0;
      if (streak < 7){ weeklyStreakStatus.textContent = 'Keep streak 7+ to claim.'; return; }
      const okJ = await awardJCoins(20, 'weekly_streak_bonus', { week: weekStr, streak });
      const okG = await awardGas(30, 'weekly_streak_bonus', { week: weekStr, streak });
      if (okJ && okG){ await setDoc(bonusRef, { lastWeekStr: weekStr, lastAt: serverTimestamp() }, { merge: true }); weeklyStreakStatus.textContent = 'Weekly bonus claimed! +20 J, +30 Gas'; }
      await loadEarningsHistory();
    }

    function openFocus(){ if (focusModal) focusModal.classList.remove('hidden'); }
    function closeFocus(){ if (focusModal) focusModal.classList.add('hidden'); if (focusTimer){ clearInterval(focusTimer); focusTimer=null; } document.removeEventListener('visibilitychange', onVisChange); window.removeEventListener('blur', onBlur); }
    function onVisChange(){ if (document.hidden){ focusFailed = true; focusContent.innerHTML = '<div class="muted">Focus lost. Challenge failed.</div>'; } }
    function onBlur(){ focusFailed = true; focusContent.innerHTML = '<div class="muted">Window blurred. Challenge failed.</div>'; }

    async function startFocusTimer(){
      if (!currentUser){ showToast('Login first.'); return; }
      const ref = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'engagement', 'daily_focus');
      const snap = await getDoc(ref);
      const now = new Date();
      if (snap.exists()){
        const last = snap.data().lastAt?.toDate();
        if (last && (now - last) < 24*60*60*1000){ focusStatus.textContent = 'Come back tomorrow.'; return; }
      }
      focusRemaining = 120; // seconds
      focusFailed = false;
      openFocus();
      focusContent.innerHTML = `<div><strong>${focusRemaining}s</strong> remaining. Stay focused…</div>`;
      document.addEventListener('visibilitychange', onVisChange);
      window.addEventListener('blur', onBlur);
      if (focusTimer) clearInterval(focusTimer);
      focusTimer = setInterval(async ()=>{
        focusRemaining--; if (focusRemaining < 0) focusRemaining = 0;
        if (!focusFailed){ focusContent.innerHTML = `<div><strong>${focusRemaining}s</strong> remaining. Stay focused…</div>`; }
        if (focusRemaining <= 0){
          clearInterval(focusTimer); focusTimer=null; closeFocus();
          if (focusFailed){ focusStatus.textContent = 'Failed. Try again tomorrow.'; await setDoc(ref, { lastAt: serverTimestamp() }, { merge: true }); return; }
          const okJ = await awardJCoins(20, 'daily_focus');
          const okG = await awardGas(35, 'daily_focus');
          if (okJ && okG){ focusStatus.textContent = 'Completed! +20 J, +35 Gas'; await setDoc(ref, { lastAt: serverTimestamp() }, { merge: true }); }
          await loadEarningsHistory();
        }
      }, 1000);
    }

    function openTyping(){ if (typingModal) typingModal.classList.remove('hidden'); }
    function closeTyping(){ if (typingModal) typingModal.classList.add('hidden'); }

    // Math Blitz helpers
    function openMathBlitz(){ if (mathBlitzModal) mathBlitzModal.classList.remove('hidden'); }
    function closeMathBlitz(){ if (mathBlitzModal) mathBlitzModal.classList.add('hidden'); if (blitzTimer){ clearInterval(blitzTimer); blitzTimer=null; } }
    function newMathQuestion(){
      const a = Math.floor(Math.random()*12)+1; const b = Math.floor(Math.random()*12)+1; const ops = ['+','-','×'];
      const op = ops[Math.floor(Math.random()*ops.length)];
      let ans = 0; if (op==='+') ans=a+b; else if (op==='-') ans=a-b; else ans=a*b;
      return { text: `${a} ${op} ${b} = ?`, ans };
    }

    async function startMathBlitz(){
      if (!currentUser){ showToast('Login first.'); return; }
      const ref = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'engagement', 'daily_math_blitz');
      const snap = await getDoc(ref);
      const now = new Date();
      if (snap.exists()){
        const last = snap.data().lastAt?.toDate();
        if (last && (now - last) < 24*60*60*1000){ mathBlitzStatus.textContent = 'Come back tomorrow.'; return; }
      }
      blitzIndex = 0; blitzCorrect = 0; blitzTimeLeft = 30; blitzStartedAt = Date.now();
      openMathBlitz();
      const q = newMathQuestion();
      mathBlitzContent.innerHTML = `<div style="font-weight:800;">Q${blitzIndex+1}/10</div><div class="mt-8">${q.text}</div><input id="blitzAnswer" type="number" style="width:100%; margin-top:8px; background:var(--input-background); color:var(--white); border:1px solid var(--border-light); border-radius:8px; padding:8px;" />
        <div class="muted mt-8">${blitzTimeLeft}s left</div>`;
      mathBlitzContent._cur = q;
      if (blitzTimer) clearInterval(blitzTimer);
      blitzTimer = setInterval(async ()=>{
        blitzTimeLeft--; const info = mathBlitzContent.querySelector('.muted'); if (info) info.textContent = `${blitzTimeLeft}s left`;
        if (blitzTimeLeft <= 0){ clearInterval(blitzTimer); blitzTimer=null; closeMathBlitz();
          await finalizeMathBlitz(ref);
        }
      }, 1000);
    }

    async function nextMathBlitzStep(){
      const input = document.getElementById('blitzAnswer');
      const val = Number((input && input.value) || '');
      if (val === mathBlitzContent._cur.ans) blitzCorrect++;
      blitzIndex++;
      if (blitzIndex >= 10){ closeMathBlitz(); if (blitzTimer){ clearInterval(blitzTimer); blitzTimer=null; } const ref = doc(db,'artifacts',appId,'users',currentUser.uid,'engagement','daily_math_blitz'); await finalizeMathBlitz(ref); return; }
      const q = newMathQuestion(); mathBlitzContent._cur = q;
      mathBlitzContent.innerHTML = `<div style="font-weight:800;">Q${blitzIndex+1}/10</div><div class="mt-8">${q.text}</div><input id="blitzAnswer" type="number" style="width:100%; margin-top:8px; background:var(--input-background); color:var(--white); border:1px solid var(--border-light); border-radius:8px; padding:8px;" />
        <div class="muted mt-8">${blitzTimeLeft}s left</div>`;
    }

    async function finalizeMathBlitz(ref){
      const passed = blitzCorrect >= 8;
      if (passed){ const okJ = await awardJCoins(20,'daily_math_blitz',{correct:blitzCorrect}); const okG = await awardGas(35,'daily_math_blitz',{correct:blitzCorrect}); if (okJ && okG){ mathBlitzStatus.textContent = `Passed ${blitzCorrect}/10. +20 J, +35 Gas`; await setDoc(ref,{lastAt:serverTimestamp()},{merge:true}); } }
      else { mathBlitzStatus.textContent = `Score ${blitzCorrect}/10. Try again tomorrow.`; await setDoc(ref,{lastAt:serverTimestamp()},{merge:true}); }
      await loadEarningsHistory();
    }

    // Word Scramble helpers
    function openScramble(){ if (scrambleModal) scrambleModal.classList.remove('hidden'); }
    function closeScramble(){ if (scrambleModal) scrambleModal.classList.add('hidden'); if (scrambleTimer){ clearInterval(scrambleTimer); scrambleTimer=null; } }
    function shuffleLetters(s){ return s.split('').sort(()=>Math.random()-0.5).join(''); }

    async function startScramble(){
      if (!currentUser){ showToast('Login first.'); return; }
      const ref = doc(db,'artifacts',appId,'users',currentUser.uid,'engagement','daily_scramble');
      const snap = await getDoc(ref); const now = new Date();
      if (snap.exists()){
        const last = snap.data().lastAt?.toDate();
        if (last && (now - last) < 24*60*60*1000){ scrambleStatus.textContent = 'Come back tomorrow.'; return; }
      }
      const words = ['community','scripture','gratitude','compassion','integrity','patience','wisdom','forgiveness'];
      scrambleWord = words[Math.floor(Math.random()*words.length)];
      const jumbled = shuffleLetters(scrambleWord);
      scrambleTimeLeft = 45;
      openScramble();
      scrambleContent.innerHTML = `<div style="font-weight:800;">Unscramble:</div><div style="margin-top:8px; font-size:1.1rem;">${jumbled}</div>
        <input id="scrambleInput" type="text" style="width:100%; margin-top:8px; background:var(--input-background); color:var(--white); border:1px solid var(--border-light); border-radius:8px; padding:8px;" />
        <div class="muted mt-8">${scrambleTimeLeft}s left</div>`;
      if (scrambleTimer) clearInterval(scrambleTimer);
      scrambleTimer = setInterval(async ()=>{
        scrambleTimeLeft--; const info = scrambleContent.querySelector('.muted'); if (info) info.textContent = `${scrambleTimeLeft}s left`;
        if (scrambleTimeLeft <= 0){ clearInterval(scrambleTimer); scrambleTimer=null; await submitScramble(); }
      },1000);
      scrambleSubmitButton.onclick = submitScramble;
      async function submitScramble(){
        closeScramble();
        const ref2 = ref;
        const input = (document.getElementById('scrambleInput')||{}).value || '';
        if (input.trim().toLowerCase() === scrambleWord){
          const okJ = await awardJCoins(15,'daily_scramble'); const okG = await awardGas(25,'daily_scramble');
          if (okJ && okG){ scrambleStatus.textContent = 'Correct! +15 J, +25 Gas'; await setDoc(ref2,{lastAt:serverTimestamp()},{merge:true}); }
          await loadEarningsHistory();
        } else {
          scrambleStatus.textContent = 'Incorrect. Try tomorrow.'; await setDoc(ref2,{lastAt:serverTimestamp()},{merge:true});
        }
      }
    }

    // Memory Match helpers
    function openMemory(){ if (memoryModal) memoryModal.classList.remove('hidden'); }
    function closeMemory(){ if (memoryModal) memoryModal.classList.add('hidden'); if (memoryTimer){ clearInterval(memoryTimer); memoryTimer=null; } }

    function makeMemoryCards(){
      const icons = ['🔥','🌙','⭐','💧']; // 4 pairs
      const pairs = icons.concat(icons);
      const shuffled = pairs.sort(()=>Math.random()-0.5);
      return shuffled.map((v,idx)=>({ id: idx, val: v, matched:false }));
    }

    async function startMemoryMatch(){
      if (!currentUser){ showToast('Login first.'); return; }
      const ref = doc(db,'artifacts',appId,'users',currentUser.uid,'engagement','daily_memory_match');
      const snap = await getDoc(ref); const now = new Date();
      if (snap.exists()){
        const last = snap.data().lastAt?.toDate();
        if (last && (now - last) < 24*60*60*1000){ memoryStatus.textContent = 'Come back tomorrow.'; return; }
      }
      memoryCards = makeMemoryCards(); memoryFlipped = []; memoryMatched = 0; memoryLocked = false; memoryTimeLeft = 60;
      openMemory();
      renderMemoryGrid();
      if (memoryTimer) clearInterval(memoryTimer);
      memoryTimer = setInterval(async ()=>{
        memoryTimeLeft--; const t = document.getElementById('memoryTimer'); if (t) t.textContent = `${memoryTimeLeft}s left`;
        if (memoryTimeLeft <= 0){ clearInterval(memoryTimer); memoryTimer=null; closeMemory(); memoryStatus.textContent = 'Time up. Try tomorrow.'; const ref2=ref; await setDoc(ref2,{lastAt:serverTimestamp()},{merge:true}); }
      },1000);
    }

    function renderMemoryGrid(){
      const grid = document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns='repeat(4,1fr)'; grid.style.gap='8px';
      memoryCards.forEach(card=>{
        const b = document.createElement('button');
        b.className = 'primary-btn'; b.setAttribute('data-id', String(card.id)); b.style.height='48px';
        b.textContent = (card.matched || memoryFlipped.includes(card.id)) ? card.val : '❓';
        b.addEventListener('click', ()=> onMemoryCardClick(card.id));
        grid.appendChild(b);
      });
      memoryContent.innerHTML = `<div class="muted" id="memoryTimer">${memoryTimeLeft}s left</div>`;
      memoryContent.appendChild(grid);
    }

    async function onMemoryCardClick(id){
      if (memoryLocked) return;
      const card = memoryCards.find(c=>c.id===id); if (!card || card.matched) return;
      if (memoryFlipped.includes(id)) return;
      memoryFlipped.push(id);
      renderMemoryGrid();
      if (memoryFlipped.length === 2){
        memoryLocked = true;
        const [aId,bId] = memoryFlipped; const a = memoryCards.find(c=>c.id===aId); const b = memoryCards.find(c=>c.id===bId);
        setTimeout(async ()=>{
          if (a && b && a.val === b.val){ a.matched=true; b.matched=true; memoryMatched+=2; }
          memoryFlipped = []; memoryLocked = false; renderMemoryGrid();
          if (memoryMatched >= memoryCards.length){
            if (memoryTimer){ clearInterval(memoryTimer); memoryTimer=null; }
            closeMemory();
            const ref = doc(db,'artifacts',appId,'users',currentUser.uid,'engagement','daily_memory_match');
            const okJ = await awardJCoins(25,'daily_memory_match'); const okG = await awardGas(40,'daily_memory_match');
            if (okJ && okG){ memoryStatus.textContent = 'Completed! +25 J, +40 Gas'; await setDoc(ref,{lastAt:serverTimestamp()},{merge:true}); }
            await loadEarningsHistory();
          }
        }, 500);
      }
    }

    function startTypingChallenge(){
      if (!currentUser){ showToast('Login first.'); return; }
      (async ()=>{
        const ref = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'engagement', 'daily_typing');
        const snap = await getDoc(ref);
        const now = new Date();
        if (snap.exists()){
          const last = snap.data().lastAt?.toDate();
          if (last && (now - last) < 24*60*60*1000){ typingStatus.textContent = 'Come back tomorrow.'; return; }
        }
        typingTarget = verses[Math.floor(Math.random()*verses.length)] + ' Keep your focus and type carefully.';
        typingStartAt = Date.now();
        openTyping();
        typingContent.innerHTML = `<div style="margin-bottom:8px; font-weight:800;">Type within 60s with 95%+ accuracy</div>
          <div class="muted" style="margin-bottom:8px;">Passage:</div>
          <div style="background:var(--input-background); padding:8px; border-radius:8px;">${typingTarget}</div>
          <textarea id="typingInput" rows="5" style="width:100%; margin-top:8px; background:var(--input-background); color:var(--white); border:1px solid var(--border-light); border-radius:8px; padding:8px;"></textarea>
          <div id="typingTimer" class="muted mt-8">60s left</div>`;
        let secs = 60;
        const timer = setInterval(()=>{
          secs--; const t = document.getElementById('typingTimer'); if (t) t.textContent = `${secs}s left`;
          if (secs <= 0){ clearInterval(timer); }
        },1000);
        typingSubmitButton.onclick = async ()=>{
          clearInterval(timer);
          const ref2 = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'engagement', 'daily_typing');
          const input = (document.getElementById('typingInput')||{}).value || '';
          const elapsed = (Date.now() - typingStartAt)/1000;
          const acc = computeAccuracy(typingTarget, input);
          closeTyping();
          if (elapsed <= 60 && acc >= 0.95){
            const okJ = await awardJCoins(30, 'daily_typing', { accuracy: acc });
            const okG = await awardGas(50, 'daily_typing', { accuracy: acc });
            if (okJ && okG){ typingStatus.textContent = `Great! ${(acc*100).toFixed(1)}% acc. +30 J, +50 Gas`; await setDoc(ref2, { lastAt: serverTimestamp() }, { merge: true }); }
            await loadEarningsHistory();
          } else {
            typingStatus.textContent = `Failed (${Math.min(100,(acc*100)).toFixed(1)}% in ${Math.round(elapsed)}s). Try tomorrow.`;
            await setDoc(ref2, { lastAt: serverTimestamp() }, { merge: true });
          }
        };
      })();
    }

    function computeAccuracy(a,b){
      const s1 = a.trim(); const s2 = b.trim();
      const len = Math.max(s1.length, s2.length) || 1;
      let match = 0; for (let i=0;i<Math.min(s1.length,s2.length);i++){ if (s1[i]===s2[i]) match++; }
      return match/len;
    }

    onAuthStateChanged(auth, async (user)=>{
      currentUser = user || null;
      if (currentUser) {
        await loadProfileAndWallet(currentUser.uid);
        await refreshStreakUI();
        await loadEarningsHistory();
      } else {
        if (walletChipAmount) walletChipAmount.textContent = '0';
        if (jcoinRateSpan) jcoinRateSpan.textContent = '0';
        if (streakLabel) streakLabel.textContent = 'Streak: 0 days';
        if (earningsList) earningsList.innerHTML = '<div class="muted">Log in to see earnings history.</div>';
      }
      renderQuests();
    });

    if (checkInButton) checkInButton.addEventListener('click', handleCheckIn);
    if (spinNowButton) spinNowButton.addEventListener('click', handleSpin);
    if (startQuizButton) startQuizButton.addEventListener('click', ()=>{ quizIndex=0; quizCorrect=0; openQuiz(); });
    if (quizNextButton) quizNextButton.addEventListener('click', nextQuizStep);
    if (quizCloseButton) quizCloseButton.addEventListener('click', closeQuiz);
    if (showVerseButton) showVerseButton.addEventListener('click', showRandomVerse);
    if (markMemorizedButton) markMemorizedButton.addEventListener('click', markMemorized);
    if (copyInviteLinkButton) copyInviteLinkButton.addEventListener('click', copyInviteLink);
    if (markReadButton) markReadButton.addEventListener('click', markReadToday);
    if (playRushButton) playRushButton.addEventListener('click', openRush);
    if (rushStartButton) rushStartButton.addEventListener('click', startRush);
    if (rushCloseButton) rushCloseButton.addEventListener('click', closeRush);
    if (claimWeeklyStreakButton) claimWeeklyStreakButton.addEventListener('click', claimWeeklyStreak);

    if (startHardQuizButton) startHardQuizButton.addEventListener('click', ()=>{ hardQuizIndex=0; hardQuizCorrect=0; openHardQuiz(); });
    if (hardQuizNextButton) hardQuizNextButton.addEventListener('click', nextHardQuizStep);
    if (hardQuizCloseButton) hardQuizCloseButton.addEventListener('click', closeHardQuiz);

    if (startFocusButton) startFocusButton.addEventListener('click', startFocusTimer);
    if (focusCloseButton) focusCloseButton.addEventListener('click', closeFocus);

    if (startTypingButton) startTypingButton.addEventListener('click', startTypingChallenge);
    if (typingCloseButton) typingCloseButton.addEventListener('click', closeTyping);

    if (startMathBlitzButton) startMathBlitzButton.addEventListener('click', startMathBlitz);
    if (mathBlitzNextButton) mathBlitzNextButton.addEventListener('click', nextMathBlitzStep);
    if (mathBlitzCloseButton) mathBlitzCloseButton.addEventListener('click', closeMathBlitz);

    if (startScrambleButton) startScrambleButton.addEventListener('click', startScramble);
    if (scrambleCloseButton) scrambleCloseButton.addEventListener('click', closeScramble);

    if (startMemoryButton) startMemoryButton.addEventListener('click', startMemoryMatch);
    if (memoryCloseButton) memoryCloseButton.addEventListener('click', closeMemory);
  </script>
</body>
</html>
