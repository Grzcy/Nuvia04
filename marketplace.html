<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grazzy - Marketplace</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://res.cloudinary.com" crossorigin>
  <link rel="preconnect" href="https://api.cloudinary.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
  <style>
    *,*::before,*::after{box-sizing:border-box}
    :root{
      --pink:#ff2e92; --blue:#00d5ff; --radius:20px; --transition:.3s ease;
      --white:#e0e0e0; --text-light:#94a3b8; --background-main:#1a1a2e; --border-light:rgba(255,255,255,.08);
      --card-background:linear-gradient(145deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      --header-background:linear-gradient(135deg, rgba(15,15,35,.95), rgba(26,26,46,.9));
      --input-background:rgba(255,255,255,.08);
      --button-background:linear-gradient(90deg, var(--blue), var(--pink));
      --button-shadow:0 4px 15px rgba(0, 213, 255, .35), 0 4px 15px rgba(255, 46, 146, .35);
      --accent-color:#00d5ff; --accent-color-dark:#00aaff; --border-color:#3a3a5a; --theme-gold:#ffd700;
    }
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;color:var(--white);background:var(--background-main)}
    header{position:sticky;top:0;z-index:10;background:var(--header-background);border-bottom:1px solid var(--border-light)}
    .header-bar{max-width:1200px;margin:0 auto;padding:10px 20px;display:flex;align-items:center;justify-content:space-between}
    .logo{font-family:Poppins,sans-serif;font-weight:800;font-size:1.6rem;background-image:linear-gradient(90deg,var(--blue),var(--pink));-webkit-background-clip:text;background-clip:text;color:transparent;text-decoration:none}
    .header-actions{display:flex;align-items:center;gap:10px}
    .icon-chip{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:50%;border:1px solid var(--border-light);background:rgba(255,255,255,.06);color:var(--white)}

    main{max-width:1100px;margin:20px auto;padding:0 16px}
    .page-title{display:flex;align-items:center;gap:10px;font-family:Poppins,sans-serif;font-weight:800;font-size:2rem;margin:6px 0 16px;background-image:linear-gradient(90deg,var(--blue),var(--pink));-webkit-background-clip:text;background-clip:text;color:transparent}

    .market-sections{display:flex;flex-direction:column;gap:24px}
    .section-card{background:var(--card-background);border:1px solid var(--border-light);border-radius:16px;padding:18px;box-shadow:0 8px 25px rgba(0,0,0,.28)}
    .section-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:12px}
    .section-title{display:flex;align-items:center;gap:10px;font-family:Poppins,sans-serif;font-weight:800;font-size:1.4rem}
    .section-sub{color:var(--text-light);font-size:.95rem}

    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:12px}
    .product-card{display:flex;flex-direction:column;gap:10px;background:rgba(255,255,255,.05);border:1px solid var(--border-light);border-radius:14px;padding:14px;position:relative;overflow:hidden}
    .product-top{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .product-title{font-weight:800}
    .product-meta{color:var(--text-light);font-size:.9rem}
    .price-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .price-badge{border:1px solid var(--border-light);border-radius:999px;padding:6px 10px;font-weight:800}
    .price-badge.primary{background:var(--button-background);border-color:transparent;box-shadow:var(--button-shadow);color:#fff}
    .price-badge.muted{background:rgba(255,255,255,.06);color:var(--white)}
    .actions{display:flex;gap:8px;margin-top:6px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;border:1px solid var(--border-light);background:var(--button-background);box-shadow:var(--button-shadow);color:#fff;font-weight:800;text-decoration:none;justify-content:center;max-width:100%;min-width:0;white-space:nowrap}
    .btn.secondary{background:rgba(255,255,255,.08);box-shadow:none}
    .actions .btn{flex:1 1 180px}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .preview-note{margin-top:6px;color:var(--text-light);font-size:.85rem}

    .theme-chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--border-light);background:rgba(255,255,255,.04);font-weight:700}
    .theme-chips{display:flex;flex-wrap:wrap;gap:6px}

    @media (max-width:600px){.page-title{font-size:1.6rem}.section-title{font-size:1.2rem}}

    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:100}
    .modal-overlay.show{display:flex}
    .modal-card{width:min(460px,92vw);background:var(--card-background);border:1px solid var(--border-light);border-radius:16px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,.5)}
    .modal-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
    .modal-title{font-family:Poppins,sans-serif;font-weight:800}
    .modal-body{display:flex;flex-direction:column;gap:10px}
    .modal-row{display:flex;flex-direction:column;gap:6px}
    .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
    .input{padding:10px;border-radius:10px;border:1px solid var(--border-light);background:var(--input-background);color:var(--white)}
    .close-btn{background:rgba(255,255,255,.08);border:1px solid var(--border-light);border-radius:10px;padding:8px 12px;color:var(--white);cursor:pointer}

    /* Global custom dialog to replace native alert/confirm/prompt */
    .global-dialog-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:110}
    .global-dialog-overlay.show{display:flex}
    .global-dialog-card{width:min(520px,94vw);background:var(--card-background);border:1px solid var(--border-light);border-radius:14px;padding:16px;box-shadow:0 10px 35px rgba(0,0,0,.6);display:flex;flex-direction:column;gap:12px}
    .global-dialog-message{color:var(--white);font-size:1rem;line-height:1.4}
    .global-dialog-actions{display:flex;gap:8px;justify-content:flex-end}
    .global-dialog-input{padding:10px;border-radius:10px;border:1px solid var(--border-light);background:var(--input-background);color:var(--white);width:100%}
  </style>
</head>
<body>
  <header>
    <div class="header-bar">
      <a class="logo" href="/index.html">Grazzy</a>
      <div class="header-actions">
        <a class="icon-chip" href="/wallet.html" aria-label="Wallet"><i class="fas fa-wallet"></i></a>
        <a class="icon-chip" href="/notifications.html" aria-label="Notifications"><i class="fas fa-bell"></i></a>
      </div>
    </div>
  </header>

  <main>
    <h1 class="page-title"><i class="fas fa-store"></i> Marketplace</h1>
    <div class="market-sections">

      <section class="section-card" aria-labelledby="themesTitle">
        <div class="section-head">
          <div class="section-title" id="themesTitle"><i class="fas fa-palette"></i> Premium Themes</div>
          <div class="section-sub">Each theme $4.00 • 800 JCoins</div>
        </div>
        <div class="theme-chips" id="themeChips"></div>
        <div class="grid" id="themesGrid"></div>
        <div class="preview-note">Preview applies temporarily. Purchase unlocks it permanently for your account.</div>
      </section>

      <section class="section-card" aria-labelledby="jcoinTitle">
        <div class="section-head">
          <div class="section-title" id="jcoinTitle"><i class="fas fa-coins"></i> JCoin Packs</div>
          <div class="section-sub">Rate: $0.005 per 1 JCoin</div>
        </div>
        <div class="grid" id="jcoinGrid"></div>
      </section>

      <section class="section-card" aria-labelledby="gasTitle">
        <div class="section-head">
          <div class="section-title" id="gasTitle"><i class="fas fa-gas-pump"></i> Gas Packs</div>
          <div class="section-sub">Default link: 1 JCoin = 10 Gas (updates if admin changed it)</div>
        </div>
        <div class="grid" id="gasGrid"></div>
      </section>

      <section class="section-card" aria-labelledby="walletTitle">
        <div class="section-head">
          <div class="section-title" id="walletTitle"><i class="fas fa-unlock"></i> Unlock Wallet</div>
          <div class="section-sub">One‑time 5,000 JCoins ($10) verification. Faster review after proof upload.</div>
        </div>
        <div class="product-card">
          <div class="product-top">
            <div>
              <div class="product-title">Wallet Unlock</div>
              <div class="product-meta">Pay and submit receipt • Developer reviews and unlocks</div>
            </div>
          </div>
          <div class="price-row">
            <span class="price-badge primary">5,000 JCoins</span>
            <span class="price-badge muted">$10.00</span>
          </div>
          <div class="actions">
            <a class="btn secondary" href="/unlock-wallet.html"><i class="fas fa-file-invoice"></i> Submit Receipt</a>
            <button class="btn" id="unlockWithJCoinsBtn" type="button"><i class="fas fa-coins"></i> Unlock with JCoins</button>
            <button class="btn secondary" id="walletUsdBtn" type="button"><i class="fas fa-dollar-sign"></i> Pay & Upload</button>
          </div>
        </div>
      </section>

      <section class="section-card" aria-labelledby="verifyTitle">
        <div class="section-head">
          <div class="section-title" id="verifyTitle"><i class="fas fa-badge-check"></i> Verified Badge</div>
          <div class="section-sub">One‑time 2,000 JCoins • $10.00</div>
        </div>
        <div class="product-card">
          <div class="product-top">
            <div>
              <div class="product-title">Get Verified</div>
              <div class="product-meta">Blue check on your name. Manual review by admin.</div>
            </div>
          </div>
          <div class="price-row">
            <span class="price-badge primary">2,000 JCoins</span>
            <span class="price-badge muted">$10.00</span>
          </div>
          <div class="actions">
            <button class="btn" id="verifyWithJCoinsBtn" type="button"><i class="fas fa-certificate"></i> Verify with JCoins</button>
            <button class="btn secondary" id="verifyUsdBtn" type="button"><i class="fas fa-dollar-sign"></i> Pay & Upload</button>
          </div>
        </div>
      </section>

    </div>
  <div class="modal-overlay" id="receiptModal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="receiptModalTitle">
      <div class="modal-head">
        <div class="modal-title" id="receiptModalTitle">Upload Payment Receipt</div>
        <button class="close-btn" id="receiptModalClose" aria-label="Close"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <div class="modal-row">
          <label for="receiptCurrency">Currency</label>
          <select id="receiptCurrency" class="input">
            <option value="USD" selected>USD</option>
            <option value="NGN">NGN</option>
          </select>
        </div>
        <div class="modal-row">
          <label for="receiptAmount">Amount</label>
          <input id="receiptAmount" type="number" step="0.01" class="input" placeholder="0.00" />
        </div>
        <div class="modal-row">
          <label for="receiptFile">Receipt Image/PDF</label>
          <input id="receiptFile" type="file" accept="image/*,.pdf" class="input" />
        </div>
        <div class="modal-row">
          <label for="receiptNote">Note (optional)</label>
          <input id="receiptNote" type="text" class="input" placeholder="e.g., Bank transfer reference" />
        </div>
        <div class="modal-actions">
          <button class="btn secondary" id="receiptCancel">Cancel</button>
          <button class="btn" id="receiptSubmit"><i class="fas fa-paper-plane"></i> Submit</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Global dialog overlay for alert/confirm/prompt replacements -->
  <div class="global-dialog-overlay" id="globalDialog" aria-hidden="true">
    <div class="global-dialog-card" role="dialog" aria-modal="true" aria-labelledby="globalDialogTitle">
      <div id="globalDialogTitle" class="modal-title" style="font-size:1.1rem">Notice</div>
      <div id="globalDialogMessage" class="global-dialog-message"></div>
      <input id="globalDialogInput" class="global-dialog-input" style="display:none" />
      <div class="global-dialog-actions" id="globalDialogActions">
        <button class="close-btn" id="globalDialogCancel" style="display:none">Cancel</button>
        <button class="btn" id="globalDialogOk">OK</button>
      </div>
    </div>
  </div>

  </main>

  <script type="module">
    const USD_PER_JCOIN = 0.005;
    let GAS_PER_JCOIN = 10; // default, will try to fetch

    const themes = [
      { id:'theme-quantum-nexus', name:'Quantum Nexus', icon:'fa-atom' },
      { id:'theme-holographic-matrix', name:'Holographic Matrix', icon:'fa-cubes' },
      { id:'theme-stellar-genesis', name:'Stellar Genesis', icon:'fa-star' },
      { id:'theme-circus-maximus', name:'Circus Maximus', icon:'fa-masks-theater' },
      { id:'theme-temporal-paradox', name:'Temporal Paradox', icon:'fa-clock' }
    ];

    const jcoinPacks = [1000, 2500, 5000, 10000, 25000];
    const gasPacks = [100, 250, 500, 1000, 2500, 5000];

    function formatUSD(v){ try{return new Intl.NumberFormat(undefined,{style:'currency',currency:'USD'}).format(v);}catch(_){return `$${Number(v).toFixed(2)}`;} }

    function el(tag, cls){ const e=document.createElement(tag); if(cls) e.className=cls; return e; }

    function renderThemes(){
      const chips = document.getElementById('themeChips');
      const grid = document.getElementById('themesGrid');
      chips.innerHTML = ''; grid.innerHTML = '';
      const fragC = document.createDocumentFragment();
      themes.forEach(t=>{
        const c = el('span','theme-chip'); c.innerHTML = `<i class="fas ${t.icon}"></i> ${t.name}`; fragC.appendChild(c);
      });
      chips.appendChild(fragC);

      const frag = document.createDocumentFragment();
      themes.forEach(t=>{
        const card = el('div','product-card');
        const top = el('div','product-top');
        const left = el('div');
        const title = el('div','product-title'); title.textContent = t.name;
        const meta = el('div','product-meta'); meta.textContent = 'Premium visual theme';
        left.appendChild(title); left.appendChild(meta);
        const icon = el('div','icon-chip'); icon.innerHTML = `<i class="fas ${t.icon}"></i>`;
        top.appendChild(left); top.appendChild(icon);
        const priceRow = el('div','price-row');
        const b1 = el('span','price-badge primary'); b1.textContent = '800 JCoins';
        const b2 = el('span','price-badge muted'); b2.textContent = '$4.00';
        priceRow.appendChild(b1); priceRow.appendChild(b2);
        const actions = el('div','actions');
        const previewBtn = el('button','btn secondary'); previewBtn.type='button'; previewBtn.innerHTML = `<i class="fas fa-eye"></i> Preview`;
        previewBtn.addEventListener('click',()=>{
          try {
            document.body.classList.remove(...Array.from(document.body.classList).filter(c=>c.startsWith('theme-')));
            document.body.classList.add(t.id);
          } catch(_){}
        });
        const buyJcBtn = el('button','btn'); buyJcBtn.type='button'; buyJcBtn.innerHTML = '<i class="fas fa-coins"></i> Buy with JCoins';
        buyJcBtn.addEventListener('click',()=> purchaseThemeWithJCoins(t));
        const buyUsdBtn = el('button','btn secondary'); buyUsdBtn.type='button'; buyUsdBtn.innerHTML = '<i class="fas fa-dollar-sign"></i> Buy with $';
        buyUsdBtn.addEventListener('click',()=> openPaymentModal('theme_usd', { theme: t }));
        actions.appendChild(previewBtn); actions.appendChild(buyJcBtn); actions.appendChild(buyUsdBtn);
        card.appendChild(top); card.appendChild(priceRow); card.appendChild(actions);
        frag.appendChild(card);
      });
      grid.appendChild(frag);
    }

    function renderJcoinPacks(){
      const grid = document.getElementById('jcoinGrid'); grid.innerHTML='';
      const frag = document.createDocumentFragment();
      jcoinPacks.forEach(qty=>{
        const usd = qty * USD_PER_JCOIN;
        const card = el('div','product-card');
        const top = el('div','product-top');
        const left = el('div');
        const title = el('div','product-title'); title.textContent = `${qty.toLocaleString()} JCoins`;
        const meta = el('div','product-meta'); meta.textContent = 'Instant credit after verification';
        left.appendChild(title); left.appendChild(meta);
        const icon = el('div','icon-chip'); icon.innerHTML = '<i class="fas fa-sack-dollar"></i>';
        top.appendChild(left); top.appendChild(icon);
        const priceRow = el('div','price-row');
        const b1 = el('span','price-badge primary'); b1.textContent = formatUSD(usd);
        const b2 = el('span','price-badge muted'); b2.textContent = `${qty.toLocaleString()} JC`;
        priceRow.appendChild(b1); priceRow.appendChild(b2);
        const actions = el('div','actions');
        const buyFiat = el('button','btn'); buyFiat.type='button'; buyFiat.innerHTML = '<i class="fas fa-file-invoice-dollar"></i> Pay & Upload';
        buyFiat.addEventListener('click',()=> openPaymentModal('jcoin_pack', { qty, usd }));
        actions.appendChild(buyFiat);
        card.appendChild(top); card.appendChild(priceRow); card.appendChild(actions);
        frag.appendChild(card);
      });
      grid.appendChild(frag);
    }

    function renderGasPacks(){
      const grid = document.getElementById('gasGrid'); grid.innerHTML='';
      const frag = document.createDocumentFragment();
      gasPacks.forEach(gas=>{
        const j = gas / GAS_PER_JCOIN; const usd = j * USD_PER_JCOIN;
        const card = el('div','product-card');
        const top = el('div','product-top');
        const left = el('div');
        const title = el('div','product-title'); title.textContent = `${gas.toLocaleString()} Gas`;
        const meta = el('div','product-meta'); meta.textContent = `${j.toFixed(1)} JCoins equivalent`;
        left.appendChild(title); left.appendChild(meta);
        const icon = el('div','icon-chip'); icon.innerHTML = '<i class="fas fa-gas-pump"></i>';
        top.appendChild(left); top.appendChild(icon);
        const priceRow = el('div','price-row');
        const b1 = el('span','price-badge primary'); b1.textContent = formatUSD(usd);
        const b2 = el('span','price-badge muted'); b2.textContent = `${j.toFixed(1)} JC`;
        priceRow.appendChild(b1); priceRow.appendChild(b2);
        const actions = el('div','actions');
        const buyJc = el('button','btn'); buyJc.type='button'; buyJc.innerHTML = '<i class="fas fa-coins"></i> Buy with JCoins';
        buyJc.addEventListener('click',()=> buyGasWithJCoins(gas));
        const buyUsd = el('button','btn secondary'); buyUsd.type='button'; buyUsd.innerHTML = '<i class="fas fa-dollar-sign"></i> Pay & Upload';
        buyUsd.addEventListener('click',()=> openPaymentModal('gas_usd', { gas }));
        actions.appendChild(buyJc); actions.appendChild(buyUsd);
        card.appendChild(top); card.appendChild(priceRow); card.appendChild(actions);
        frag.appendChild(card);
      });
      grid.appendChild(frag);
    }

    renderThemes();
    renderJcoinPacks();
    renderGasPacks();

    // --- Global custom dialog overrides (replace native alert/confirm/prompt) ---
    (function(){
      const overlay = document.getElementById('globalDialog');
      const msgEl = document.getElementById('globalDialogMessage');
      const titleEl = document.getElementById('globalDialogTitle');
      const inputEl = document.getElementById('globalDialogInput');
      const okBtn = document.getElementById('globalDialogOk');
      const cancelBtn = document.getElementById('globalDialogCancel');

      function showDialog({ type='alert', title='Notice', message='', defaultValue='' } = {}){
        return new Promise((resolve) => {
          titleEl.textContent = title;
          msgEl.textContent = typeof message === 'string' ? message : JSON.stringify(message);
          inputEl.style.display = type === 'prompt' ? 'block' : 'none';
          inputEl.value = defaultValue || '';
          cancelBtn.style.display = type === 'confirm' || type === 'prompt' ? 'inline-flex' : 'none';
          overlay.classList.add('show'); overlay.setAttribute('aria-hidden','false');

          function cleanup(){ overlay.classList.remove('show'); overlay.setAttribute('aria-hidden','true'); okBtn.removeEventListener('click', onOk); cancelBtn.removeEventListener('click', onCancel); document.removeEventListener('keydown', onKey); }
          function onOk(){ try{ const val = type === 'prompt' ? inputEl.value : true; cleanup(); resolve(type === 'prompt' ? val : true); }catch(e){ cleanup(); resolve(type === 'prompt' ? null : true); } }
          function onCancel(){ cleanup(); resolve(type === 'prompt' ? null : false); }
          function onKey(e){ if(e.key === 'Escape'){ onCancel(); } else if(e.key === 'Enter'){ onOk(); } }

          okBtn.addEventListener('click', onOk);
          cancelBtn.addEventListener('click', onCancel);
          document.addEventListener('keydown', onKey);
          // focus logic
          setTimeout(()=>{ if(type==='prompt'){ inputEl.focus(); inputEl.select(); } else { okBtn.focus(); } },50);
        });
      }

      // Preserve originals just in case
      window.__nativeDialogs = { alert: window.alert.bind(window), confirm: window.confirm.bind(window), prompt: window.prompt.bind(window) };

      window.alert = (msg) => { try{ return showDialog({ type:'alert', message: String(msg) }); }catch(e){ window.__nativeDialogs.alert(String(msg)); } };
      window.confirm = (msg) => { try{ return showDialog({ type:'confirm', message: String(msg) }); }catch(e){ return Promise.resolve(window.__nativeDialogs.confirm(String(msg))); } };
      window.prompt = (msg, def='') => { try{ return showDialog({ type:'prompt', message: String(msg), defaultValue: def||'' }); }catch(e){ return Promise.resolve(window.__nativeDialogs.prompt(String(msg), def)); } };
    })();

    // Basic receipt modal handlers available even if firebase fails
    let modalEl = document.getElementById('receiptModal');
    let modalClose = document.getElementById('receiptModalClose');
    let receiptCancel = document.getElementById('receiptCancel');
    let receiptSubmit = document.getElementById('receiptSubmit');
    let receiptAmount = document.getElementById('receiptAmount');
    let receiptCurrency = document.getElementById('receiptCurrency');
    let receiptFile = document.getElementById('receiptFile');
    let receiptNote = document.getElementById('receiptNote');
    let modalTitle = document.getElementById('receiptModalTitle');
    let modalState = { type:null, payload:null };

    function openPaymentModal(type, payload){
      modalState = { type, payload };
      if (!modalEl) modalEl = document.getElementById('receiptModal');
      if (!modalTitle) modalTitle = document.getElementById('receiptModalTitle');
      try{
        if (type === 'theme_usd') { modalTitle.textContent = `Pay $4.00 • ${payload.theme.name}`; if(receiptAmount) receiptAmount.value = 4.00; if(receiptCurrency) receiptCurrency.value = 'USD'; }
        else if (type === 'jcoin_pack') { modalTitle.textContent = `Buy ${payload.qty.toLocaleString()} JCoins`; if(receiptAmount) receiptAmount.value = (payload.usd||0).toFixed(2); if(receiptCurrency) receiptCurrency.value = 'USD'; }
        else if (type === 'gas_usd') { const j = payload.gas / GAS_PER_JCOIN; const usd = j * USD_PER_JCOIN; modalTitle.textContent = `Buy ${payload.gas} Gas`; if(receiptAmount) receiptAmount.value = usd.toFixed(2); if(receiptCurrency) receiptCurrency.value = 'USD'; }
        else if (type === 'wallet_unlock_usd') { modalTitle.textContent = 'Wallet Unlock ($10)'; if(receiptAmount) receiptAmount.value = 10.00; if(receiptCurrency) receiptCurrency.value = 'USD'; }
        else if (type === 'verify_usd') { modalTitle.textContent = 'Verified Badge ($10)'; if(receiptAmount) receiptAmount.value = 10.00; if(receiptCurrency) receiptCurrency.value = 'USD'; }
        if (modalEl) { modalEl.classList.add('show'); modalEl.setAttribute('aria-hidden','false'); }
      }catch(e){ console.warn('openPaymentModal error', e); }
    }
    function closePaymentModal(){ if (!modalEl) modalEl = document.getElementById('receiptModal'); if (!modalEl) return; modalEl.classList.remove('show'); modalEl.setAttribute('aria-hidden','true'); if (receiptFile) receiptFile.value=''; if (receiptNote) receiptNote.value=''; }
    modalClose?.addEventListener('click', closePaymentModal);
    receiptCancel?.addEventListener('click', closePaymentModal);
    // fallback submit when firebase not available
    receiptSubmit?.addEventListener('click', ()=>{ alert('Receipt submitted (offline mode).'); closePaymentModal(); });

    try{
      const { initializeApp } = await import('https://www.gstatic.com/firebasejs/11.8.0/firebase-app.js');
      const { getFirestore, doc, getDoc, setDoc, serverTimestamp, addDoc, collection, runTransaction, updateDoc, increment, arrayUnion } = await import('https://www.gstatic.com/firebasejs/11.8.0/firebase-firestore.js');
      const { getAuth, onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/11.8.0/firebase-auth.js');

      const firebaseConfig = typeof window.__firebase_config !== 'undefined' ? JSON.parse(window.__firebase_config) : {
        apiKey: "AIzaSyAm8ghbQ_lwJdNXEhWGos0eyi5wtvGuRR4",
        authDomain: "grazzy-9e736.firebaseapp.com",
        databaseURL: "https://grazzy-9e736-default-rtdb.firebaseio.com",
        projectId: "grazzy-9e736",
        storageBucket: "grazzy-9e736.firebasestorage.app",
        messagingSenderId: "750326949170",
        appId: "1:750326949170:web:5d19744aafc8675918632b",
        measurementId: "G-MRFSQPPCLV"
      };
      const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      // Try fetch J/G link setting
      try{
        const linkRef = doc(db, 'artifacts', appId, 'public', 'data', 'system_settings', 'jg_link_settings');
        const snap = await getDoc(linkRef);
        if (snap.exists()){
          const rate = Number(snap.data().jCoinsPerGas || 10);
          if (rate > 0){ GAS_PER_JCOIN = rate; renderGasPacks(); }
        }
      }catch(_){ }

      // Verification request
      const requestBtn = document.getElementById('requestVerifyBtn');
      if (requestBtn){
        requestBtn.addEventListener('click', async ()=>{
          onAuthStateChanged(auth, async (user)=>{
            if (!user){ alert('Please log in first.'); return; }
            try {
              const col = collection(db, 'artifacts', appId, 'public', 'data', 'verification_requests');
              await addDoc(col, {
                userId: user.uid,
                priceJCoins: 2000,
                priceUSD: 2000 * USD_PER_JCOIN,
                status: 'pending',
                createdAt: serverTimestamp()
              });
              alert('Verification request sent. An admin will review it shortly.');
            } catch (e) {
              alert(`Failed to send request: ${e?.message||e}`);
            }
          });
        });
      }

      // --- Payment Flow Helpers ---
      const ADMIN_UID = (typeof window !== 'undefined' && window.ADMIN_UID) ? window.ADMIN_UID : 'RJZ8xhsjEsdKBGFYveWO0Rsq1Zz1';

      async function ensureUser() {
        return new Promise((resolve) => {
          onAuthStateChanged(auth, (u) => {
            if (!u) { alert('Please log in first.'); resolve(null); }
            else resolve(u);
          });
        });
      }

      async function purchaseThemeWithJCoins(theme) {
        const user = await ensureUser(); if (!user) return;
        const priceJC = 800;
        try {
          await runTransaction(db, async (tx) => {
            const profileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profiles', 'user_profile');
            const entRefA = doc(db, 'artifacts', appId, 'users', user.uid, 'profiles', 'user_entitlements');
            const entRefB = doc(db, 'artifacts', appId, 'users', user.uid, 'user_entitlements');
            const profSnap = await tx.get(profileRef);
            if (!profSnap.exists()) throw new Error('Profile not found');
            const data = profSnap.data() || {};
            const cur = Number(data.jCoins || 0);
            if (cur < priceJC) throw new Error('Not enough JCoins');
            tx.update(profileRef, { jCoins: cur - priceJC, updatedAt: serverTimestamp() });
            const entUpdates = {};
            entUpdates.themes = arrayUnion(theme.id);
            entUpdates[`theme_${theme.id}_purchased`] = true;
            entUpdates[`theme_${theme.id}_purchase_date`] = serverTimestamp();
            entUpdates.updatedAt = serverTimestamp();
            tx.set(entRefA, entUpdates, { merge: true });
            tx.set(entRefB, entUpdates, { merge: true });
          });
          alert('Theme unlocked with JCoins.');
        } catch (e) {
          alert(e?.message || 'Purchase failed');
        }
      }

      async function requestThemePurchaseUSD(theme) {
        const user = await ensureUser(); if (!user) return;
        try {
          const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'shop_payment_requests');
          await addDoc(colRef, {
            userId: user.uid,
            assignedAdminId: ADMIN_UID,
            status: 'pending',
            paymentMethod: 'fiat',
            items: [{ id: theme.id, category: 'premium_theme', themeKey: theme.id, themeName: theme.name, price: 4.0 }],
            userCurrencyCode: 'USD',
            userCurrencyAmount: 4.0,
            timestamp: serverTimestamp()
          });
          await alert('Request sent. Developer will review shortly.');
          window.location.href = '/developer.html';
        } catch (e) {
          alert(e?.message || 'Failed to create request');
        }
      }

      async function unlockWalletWithJCoins() {
        const user = await ensureUser(); if (!user) return;
        const priceJC = 5000;
        try {
          await runTransaction(db, async (tx) => {
            const profileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profiles', 'user_profile');
            const profSnap = await tx.get(profileRef);
            if (!profSnap.exists()) throw new Error('Profile not found');
            const data = profSnap.data() || {};
            const cur = Number(data.jCoins || 0);
            if (cur < priceJC) throw new Error('Not enough JCoins');
            tx.update(profileRef, { jCoins: cur - priceJC, walletUnlocked: true, updatedAt: serverTimestamp() });
            const txCol = collection(db, 'artifacts', appId, 'users', user.uid, 'transactions');
            tx.set(doc(txCol), { type: 'wallet_unlock_jcoins', amount: -priceJC, timestamp: serverTimestamp() });
          });
          alert('Wallet unlocked successfully.');
        } catch (e) {
          alert(e?.message || 'Failed to unlock wallet');
        }
      }

      async function verifyWithJCoins() {
        const user = await ensureUser(); if (!user) return;
        const priceJC = 2000;
        try {
          await runTransaction(db, async (tx) => {
            const profileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profiles', 'user_profile');
            const profSnap = await tx.get(profileRef);
            if (!profSnap.exists()) throw new Error('Profile not found');
            const data = profSnap.data() || {};
            const cur = Number(data.jCoins || 0);
            if (cur < priceJC) throw new Error('Not enough JCoins');
            tx.update(profileRef, { jCoins: cur - priceJC, verified: true, updatedAt: serverTimestamp() });
          });
          alert('You are now verified.');
        } catch (e) {
          alert(e?.message || 'Verification failed');
        }
      }

      async function buyGasWithJCoins(gasAmount) {
        const user = await ensureUser(); if (!user) return;
        const jcoinsNeeded = gasAmount / GAS_PER_JCOIN;
        try {
          await runTransaction(db, async (tx) => {
            const profileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profiles', 'user_profile');
            const profSnap = await tx.get(profileRef);
            if (!profSnap.exists()) throw new Error('Profile not found');
            const data = profSnap.data() || {};
            const curJ = Number(data.jCoins || 0);
            if (curJ < jcoinsNeeded) throw new Error('Not enough JCoins');
            const newJ = curJ - jcoinsNeeded;
            const newGas = Number(data.gas || 0) + gasAmount;
            const newTotalGas = Number(data.totalGasEarned || 0) + gasAmount;
            tx.update(profileRef, { jCoins: newJ, gas: newGas, totalGasEarned: newTotalGas, updatedAt: serverTimestamp() });
            const txCol = collection(db, 'artifacts', appId, 'users', user.uid, 'transactions');
            tx.set(doc(txCol), { type: 'buy_gas_jcoins', amount: gasAmount, jCoinsSpent: jcoinsNeeded, timestamp: serverTimestamp() });
          });
          alert('Gas added to your account.');
        } catch (e) {
          alert(e?.message || 'Failed to buy gas');
        }
      }

      // Attach handlers for static buttons
      document.getElementById('unlockWithJCoinsBtn')?.addEventListener('click', unlockWalletWithJCoins);
      document.getElementById('verifyWithJCoinsBtn')?.addEventListener('click', verifyWithJCoins);

      // Receipt Modal
      const cloudinaryConfig = { cloudName: 'dxld01rcp', uploadPreset: 'Storage_preset' };
      // DOM references already initialized above; re-query to ensure they're up-to-date
      modalEl = document.getElementById('receiptModal');
      modalClose = document.getElementById('receiptModalClose');
      receiptCancel = document.getElementById('receiptCancel');
      receiptSubmit = document.getElementById('receiptSubmit');
      receiptAmount = document.getElementById('receiptAmount');
      receiptCurrency = document.getElementById('receiptCurrency');
      receiptFile = document.getElementById('receiptFile');
      receiptNote = document.getElementById('receiptNote');
      modalTitle = document.getElementById('receiptModalTitle');

      function openPaymentModal(type, payload){
        modalState = { type, payload };
        if (type === 'theme_usd') { modalTitle.textContent = `Pay $4.00 • ${payload.theme.name}`; receiptAmount.value = 4.00; receiptCurrency.value = 'USD'; }
        else if (type === 'jcoin_pack') { modalTitle.textContent = `Buy ${payload.qty.toLocaleString()} JCoins`; receiptAmount.value = (payload.usd||0).toFixed(2); receiptCurrency.value = 'USD'; }
        else if (type === 'gas_usd') { const j = payload.gas / GAS_PER_JCOIN; const usd = j * USD_PER_JCOIN; modalTitle.textContent = `Buy ${payload.gas} Gas`; receiptAmount.value = usd.toFixed(2); receiptCurrency.value = 'USD'; }
        else if (type === 'wallet_unlock_usd') { modalTitle.textContent = 'Wallet Unlock ($10)'; receiptAmount.value = 10.00; receiptCurrency.value = 'USD'; }
        else if (type === 'verify_usd') { modalTitle.textContent = 'Verified Badge ($10)'; receiptAmount.value = 10.00; receiptCurrency.value = 'USD'; }
        modalEl.classList.add('show'); modalEl.setAttribute('aria-hidden','false');
      }
      function closePaymentModal(){ modalEl.classList.remove('show'); modalEl.setAttribute('aria-hidden','true'); receiptFile.value=''; receiptNote.value=''; }
      modalClose?.addEventListener('click', closePaymentModal);
      receiptCancel?.addEventListener('click', closePaymentModal);

      async function uploadReceipt(file){
        if (!file) return null;
        const fd = new FormData(); fd.append('file', file);
        if (cloudinaryConfig.uploadPreset) fd.append('upload_preset', cloudinaryConfig.uploadPreset);
        const type = file.type && file.type.includes('pdf') ? 'raw' : 'auto';
        const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/${type}/upload`, { method:'POST', body: fd });
        const data = await res.json(); if(!res.ok) throw new Error(data?.error?.message||'Upload failed');
        return data.secure_url || data.url;
      }

      async function handleReceiptSubmit(){
        const file = receiptFile.files && receiptFile.files[0];
        const amt = Number(receiptAmount.value||0);
        const cur = receiptCurrency.value || 'USD';
        if (!file || !amt) { alert('Provide amount and receipt.'); return; }
        const user = await new Promise(r=>onAuthStateChanged(auth,u=>r(u))); if(!user){ alert('Please log in first.'); return; }
        try {
          const rUrl = await uploadReceipt(file);
          if (!rUrl) throw new Error('Upload failed');
          if (modalState.type === 'theme_usd'){
            const t = modalState.payload.theme;
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'shop_payment_requests'), {
              userId: user.uid, assignedAdminId: ADMIN_UID, status:'pending', paymentMethod:'fiat', userCurrencyCode: cur, userCurrencyAmount: amt,
              receiptUrl: rUrl, timestamp: serverTimestamp(),
              items: [{ id: t.id, category:'premium_theme', themeKey: t.id, themeName: t.name, price: 4.0 }]
            });
            alert('Receipt submitted. Developer will review.');
          } else if (modalState.type === 'jcoin_pack'){
            const qty = modalState.payload.qty;
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'jcoin_buy_requests'), {
              userId: user.uid, requestedJCoins: qty, receiptImageUrl: rUrl, status:'pending', timestamp: serverTimestamp(), userCurrencyCode: cur, userCurrencyAmount: amt, note: (receiptNote.value||'')
            });
            alert('JCoin purchase request submitted.');
          } else if (modalState.type === 'gas_usd'){
            const gas = modalState.payload.gas; const j = gas / GAS_PER_JCOIN;
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'shop_payment_requests'), {
              userId: user.uid, assignedAdminId: ADMIN_UID, status:'pending', paymentMethod:'fiat', userCurrencyCode: cur, userCurrencyAmount: amt,
              receiptUrl: rUrl, timestamp: serverTimestamp(),
              items: [{ id:`gas_${gas}`, category:'gas_pack', gasAmount: gas, jCoinsEquivalent: j, priceUSD: amt }]
            });
            alert('Gas payment submitted. Developer will credit after approval.');
          } else if (modalState.type === 'wallet_unlock_usd'){
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'wallet_unlock_requests'), {
              userId: user.uid, status:'pending', amountUSD: amt, receiptUrl: rUrl, timestamp: serverTimestamp()
            });
            alert('Wallet unlock receipt submitted.');
          } else if (modalState.type === 'verify_usd'){
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'shop_payment_requests'), {
              userId: user.uid, assignedAdminId: ADMIN_UID, status:'pending', paymentMethod:'fiat', userCurrencyCode: cur, userCurrencyAmount: amt,
              receiptUrl: rUrl, timestamp: serverTimestamp(), verificationBadge: true
            });
            alert('Verification receipt submitted.');
          }
          closePaymentModal();
        } catch(e){ alert(e?.message||'Failed to submit'); }
      }
      receiptSubmit?.addEventListener('click', handleReceiptSubmit);
      document.getElementById('walletUsdBtn')?.addEventListener('click', ()=> openPaymentModal('wallet_unlock_usd', {}));
      document.getElementById('verifyUsdBtn')?.addEventListener('click', ()=> openPaymentModal('verify_usd', {}));

    }catch(_){ /* offline or firebase not available; soft-fail */ }
  </script>
</body>
</html>
