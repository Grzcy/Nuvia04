<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grazzy - Content Moderation</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://*.firebaseio.com" crossorigin>
  <link rel="preconnect" href="https://res.cloudinary.com" crossorigin>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" onload="this.rel='stylesheet'" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" /></noscript>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js" defer crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    *, *::before, *::after { box-sizing: border-box; }
    :root {
      --pink: #ff2e92;
      --blue: #00d5ff;
      --radius: 20px;
      --transition: .3s ease;
      --white: #fff;
      --text-light: rgba(255, 255, 255, .7);
      --background-main: rgba(10, 10, 10, .75);
      --background-gradient-1: #00d5ff;
      --background-gradient-2: #ff2e92;
      --card-background: linear-gradient(145deg, rgba(255, 255, 255, .03), rgba(255, 255, 255, .01));
      --header-background: linear-gradient(135deg, rgba(10, 10, 10, .85), rgba(10, 10, 10, .75));
      --border-light: rgba(255, 255, 255, .05);
      --input-background: rgba(255, 255, 255, 0.05);
      --button-background: linear-gradient(90deg, var(--blue), var(--pink));
      --button-shadow: 0 4px 15px var(--blue), 0 4px 15px var(--pink);

      --background-color-primary: #1a1a2e;
      --background-color-secondary: #0f0f1f;
      --header-background-color: #2a2a4a;
      --footer-background-color: #2a2a4a;
      --content-background-color: #20203a;
      --card-background-color: #2a2a4a;
      --text-color-primary: #e0e0e0;
      --text-color-secondary: #b0b0d0;
      --accent-color: #00d5ff;
      --accent-color-dark: #00aaff;
      --border-color: #3a3a5a;
      --notification-badge-color: #ff2e92;
      --delete-button-color: #dc3545;
      --warning-color: #ffc107;
    }

    body {
      min-height: 100vh; margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center;
      background-color: var(--background-main);
      background-image: radial-gradient(circle at top left, var(--background-gradient-1), transparent 100px),
                        radial-gradient(circle at bottom right, var(--background-gradient-2), transparent 150px);
      color: var(--white); font-family: 'Inter', sans-serif; overflow-x: hidden;
    }

    header { background: var(--header-background); border-bottom: 1px solid var(--border-light); padding: 10px 0; box-shadow: 0 4px 15px rgba(0,0,0,.2); position: fixed; top: 0; left: 0; width: 100%; height: 55px; z-index: 10; display: flex; justify-content: center; }
    header .header-content-wrapper { display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 1200px; padding: 0 30px; }
    .logo { font-family: 'Poppins', sans-serif; font-size: 1.8rem; font-weight: 800; background-clip: text; color: transparent; background-image: linear-gradient(90deg, var(--blue), var(--pink)); letter-spacing: -0.03em; text-decoration: none; display: inline-flex; align-items: center; gap: 10px; }
    .user-profile-header { display: flex; align-items: center; gap: 10px; }
    #logoutButton { background: var(--button-background); border: none; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.3); transition: transform .2s ease, box-shadow .2s ease, opacity .3s ease; opacity: .8; margin-left: 10px; }
    #logoutButton:hover { transform: scale(1.1); box-shadow: var(--button-shadow); opacity: 1; }
    #logoutButton i { color: var(--white); font-size: .9rem; }
    #headerProfilePic { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent-color); box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: none; }
    #headerAvatarIcon { font-size: 30px; color: var(--text-light); }
    #headerDisplayName { font-weight: 600; font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 120px; }

    main { flex-grow: 1; padding: 40px 0; padding-top: 80px; width: 100%; display: flex; flex-direction: column; align-items: center; }
    .content-wrapper { width: 100%; max-width: 1100px; padding: 20px; display: flex; flex-direction: column; gap: 24px; align-items: center; }

    .section-card { background: var(--card-background); border: 1px solid var(--border-color); backdrop-filter: blur(10px) saturate(180%); border-radius: var(--radius); box-shadow: 0 8px 25px rgba(0,0,0,.3); padding: 2rem; width: 100%; max-width: 1000px; display: flex; flex-direction: column; gap: 16px; }
    .section-title { font-family: 'Poppins', sans-serif; font-weight: 800; background-clip: text; color: transparent; background-image: linear-gradient(90deg, var(--blue), var(--pink)); font-size: 2.2rem; margin: 0; }
    .section-subtitle { color: var(--text-light); margin: 0; font-weight: 600; }

    .filters-toolbar { display: grid; grid-template-columns: repeat(12, 1fr); gap: 12px; align-items: end; }
    .filter-field { display: flex; flex-direction: column; gap: 6px; }
    .filter-field label { color: var(--text-light); font-size: .85rem; font-weight: 700; }
    .select-input, .text-input { background: var(--input-background); border: 1px solid var(--border-light); color: var(--white); border-radius: 10px; padding: 10px 12px; width: 100%; }
    .select-input:focus, .text-input:focus { outline: none; box-shadow: 0 0 0 2px rgba(0,213,255,.2); border-color: rgba(255,255,255,.2); }

    .bulk-actions { display: flex; flex-wrap: wrap; gap: 10px; }
    .btn { display: inline-flex; align-items: center; gap: 8px; border: 1px solid var(--border-light); color: var(--white); background: var(--input-background); border-radius: 999px; padding: 8px 12px; cursor: pointer; font-weight: 700; text-decoration: none; }
    .btn:hover { background: rgba(255,255,255,.06); }
    .btn-primary { background: var(--button-background); border: none; box-shadow: var(--button-shadow); }
    .btn-danger { background: linear-gradient(90deg, #f44336, #b71c1c); border: none; }
    .btn-warning { background: linear-gradient(90deg, #ff9800, #ef6c00); border: none; }
    .btn-success { background: linear-gradient(90deg, #4caf50, #2e7d32); border: none; }

    .reports-list { display: grid; grid-template-columns: 1fr; gap: 12px; }
    .report-card { background: var(--input-background); border: 1px solid var(--border-light); border-radius: 14px; padding: 14px; display: grid; grid-template-columns: auto 1fr auto; gap: 12px; align-items: center; }
    .report-select { display: flex; align-items: center; justify-content: center; }
    .report-meta { display: grid; gap: 6px; }
    .report-title { margin: 0; font-size: 1rem; font-weight: 800; color: var(--white); }
    .report-details { margin: 0; color: var(--text-light); font-size: .9rem; }
    .report-tags { display: flex; flex-wrap: wrap; gap: 6px; }
    .tag { display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; border-radius: 999px; background: rgba(255,255,255,.06); border: 1px solid var(--border-light); font-size: .75rem; color: var(--white); }
    .report-actions { display: flex; flex-wrap: wrap; gap: 8px; justify-content: flex-end; }

    .empty-state { text-align: center; color: var(--text-light); padding: 20px; border: 1px dashed var(--border-light); border-radius: 12px; }

    .toolbar-row { display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap; }
    .left-tools, .right-tools { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .counter-badge { background: linear-gradient(135deg, var(--pink), var(--blue)); color: #fff; border-radius: 999px; padding: 6px 10px; font-weight: 800; }

    .message-box { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: var(--card-background-color); color: var(--text-color-primary); padding: 20px 30px; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,.4); z-index: 1000; display: none; opacity: 0; transition: opacity .3s ease-in-out, transform .3s ease-in-out; min-width: 280px; max-width: 90%; text-align: center; flex-direction: column; align-items: center; gap: 15px; }
    .message-box.show { opacity: 1; display: flex; }
    .message-box.success { background-image: linear-gradient(45deg, var(--pink), var(--blue)); color: var(--white); border: none; box-shadow: 0 8px 30px rgba(0,213,255,.5), 0 8px 30px rgba(255,46,146,.5); }
    .message-box.error { border-left: 5px solid var(--delete-button-color); background-color: var(--card-background-color); color: var(--text-color-primary); }
    .message-box.info { border-left: 5px solid var(--accent-color); background-color: var(--card-background-color); color: var(--text-color-primary); }
    .message-box.warning { border-left: 5px solid var(--warning-color); background-color: var(--card-background-color); color: var(--text-color-primary); }
    .message-box i { font-size: 2.5rem; margin-bottom: 5px; background-image: linear-gradient(90deg, var(--blue), var(--pink)); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; color: transparent; }

    @media (max-width: 860px) { .filters-toolbar { grid-template-columns: 1fr 1fr; } .report-card { grid-template-columns: auto 1fr; } .report-actions { justify-content: flex-start; } }
  </style>
</head>
<body class="theme-dark-mode">
  <header>
    <div class="header-content-wrapper">
      <a href="/index.html" class="logo"><img src="assets/security.png" alt="Grazzy Security" style="height:24px;width:auto" onerror="this.style.display='none'"><span>Grazzy</span></a>
      <div class="user-profile-header">
        <button id="logoutButton" aria-label="Logout" disabled><i class="fas fa-sign-out-alt"></i></button>
        <a href="/profile.html" id="profileLink">
          <img id="headerProfilePic" src="" alt="Profile Picture">
          <i id="headerAvatarIcon" class="fas fa-user-circle"></i>
          <span id="headerDisplayName">Loading...</span>
        </a>
      </div>
    </div>
  </header>

  <main>
    <div class="content-wrapper">
      <div class="section-card">
        <h1 class="section-title">Content Moderation Center</h1>
        <p class="section-subtitle"><i class="fas fa-shield-alt"></i> Review, act on, and resolve reported content in real time.</p>

        <div class="toolbar-row">
          <div class="left-tools">
            <span class="counter-badge" id="reportsCounter">0 Reports</span>
            <label class="btn" title="Select/Deselect all">
              <input type="checkbox" id="selectAllCheckbox" style="margin-right:8px"> Select All
            </label>
          </div>
          <div class="right-tools bulk-actions">
            <button class="btn btn-success" id="bulkResolveBtn"><i class="fas fa-check"></i> Resolve</button>
            <button class="btn btn-warning" id="bulkIgnoreBtn"><i class="fas fa-ban"></i> Ignore</button>
            <button class="btn btn-danger" id="bulkDeleteBtn"><i class="fas fa-trash"></i> Delete Content</button>
          </div>
        </div>

        <div class="filters-toolbar" role="region" aria-label="Moderation filters">
          <div class="filter-field" style="grid-column: span 3;">
            <label for="statusFilter">Status</label>
            <select id="statusFilter" class="select-input">
              <option value="pending" selected>Pending</option>
              <option value="open">Open</option>
              <option value="warned">Warned</option>
              <option value="content_deleted">Content Deleted</option>
              <option value="resolved">Resolved</option>
              <option value="ignored">Ignored</option>
            </select>
          </div>
          <div class="filter-field" style="grid-column: span 3;">
            <label for="typeFilter">Type</label>
            <select id="typeFilter" class="select-input">
              <option value="">All types</option>
              <option value="post">Post</option>
              <option value="comment">Comment</option>
              <option value="profile">Profile</option>
              <option value="message">Message</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="filter-field" style="grid-column: span 6;">
            <label for="searchInput">Search</label>
            <input id="searchInput" class="text-input" type="search" placeholder="Search reason, content, user IDs, content IDs">
          </div>
        </div>

        <div class="reports-list" id="reportsList" aria-live="polite"></div>
        <div class="empty-state" id="emptyState" style="display:none">No reports found for the selected filters.</div>
      </div>
    </div>
  </main>

  <div id="messageBox" class="message-box" role="alert" aria-live="assertive"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, query, where, orderBy, onSnapshot, addDoc, updateDoc, serverTimestamp, writeBatch, limit, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
      apiKey: "AIzaSyDz-8N0totzvMCvonF9pKj9RsoH3J8xL0w",
      authDomain: "jchat-1.firebaseapp.com",
      databaseURL: "https://jchat-1-default-rtdb.firebaseio.com",
      projectId: "jchat-1",
      storageBucket: "jchat-1.firebasestorage.app",
      messagingSenderId: "328479683167",
      appId: "1:328479683167:web:276c0b7e8ea44dd2d6a1ea",
      measurementId: "G-S6Z9GG0R9P"
    };
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const headerProfilePic = document.getElementById('headerProfilePic');
    const headerAvatarIcon = document.getElementById('headerAvatarIcon');
    const headerDisplayName = document.getElementById('headerDisplayName');
    const logoutButton = document.getElementById('logoutButton');
    const messageBox = document.getElementById('messageBox');
    const profileLink = document.getElementById('profileLink');

    const reportsList = document.getElementById('reportsList');
    const emptyState = document.getElementById('emptyState');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const bulkResolveBtn = document.getElementById('bulkResolveBtn');
    const bulkIgnoreBtn = document.getElementById('bulkIgnoreBtn');
    const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
    const statusFilter = document.getElementById('statusFilter');
    const typeFilter = document.getElementById('typeFilter');
    const searchInput = document.getElementById('searchInput');
    const reportsCounter = document.getElementById('reportsCounter');

    const ADMIN_UID = (typeof window !== 'undefined' && window.ADMIN_UID) ? window.ADMIN_UID : 'RJZ8xhsjEsdKBGFYveWO0Rsq1Zz1';

    const successSynth = new Tone.Synth().toDestination();
    const errorSynth = new Tone.Synth().toDestination();
    const infoSynth = new Tone.Synth().toDestination();
    successSynth.oscillator.type = "sine"; successSynth.envelope.attack = 0.01; successSynth.envelope.decay = 0.2; successSynth.envelope.sustain = 0.0; successSynth.envelope.release = 0.5;
    errorSynth.oscillator.type = "sawtooth"; errorSynth.envelope.attack = 0.01; errorSynth.envelope.decay = 0.3; errorSynth.envelope.sustain = 0.0; errorSynth.envelope.release = 0.5;
    infoSynth.oscillator.type = "triangle"; infoSynth.envelope.attack = 0.01; infoSynth.envelope.decay = 0.1; infoSynth.envelope.sustain = 0.0; infoSynth.envelope.release = 0.3;
    function playNotificationSound(type){ Tone.start(); if(type==='success') successSynth.triggerAttackRelease('C5','8n'); else if(type==='error') errorSynth.triggerAttackRelease('C3','8n'); else infoSynth.triggerAttackRelease('E4','16n'); }

    function showMessageBox(message, type='info', durationMs=3000, isPersistent=false){
      if(messageBox.timeoutId){ clearTimeout(messageBox.timeoutId); messageBox.timeoutId = null; }
      messageBox.innerHTML = `<i id="messageBoxIcon"></i><span id="messageBoxText"></span>`;
      const messageBoxIcon = document.getElementById('messageBoxIcon');
      const messageBoxText = document.getElementById('messageBoxText');
      messageBoxText.textContent = message; messageBox.className = 'message-box show ' + type;
      messageBoxIcon.className = '';
      if (type === 'success') { messageBoxIcon.classList.add('fas','fa-check-circle'); playNotificationSound('success'); }
      else if (type === 'error') { messageBoxIcon.classList.add('fas','fa-times-circle'); playNotificationSound('error'); }
      else if (type === 'warning') { messageBoxIcon.classList.add('fas','fa-exclamation-triangle'); playNotificationSound('info'); }
      else if (type === 'info') { messageBoxIcon.classList.add('fas','fa-info-circle'); playNotificationSound('info'); }
      else if (type === 'loading') { messageBoxIcon.classList.add('fas','fa-spinner','fa-spin'); }
      messageBox.style.display = 'flex'; messageBox.style.opacity = '1';
      if (!isPersistent) { messageBox.timeoutId = setTimeout(()=>{ messageBox.style.opacity = '0'; messageBox.addEventListener('transitionend', function handler(){ messageBox.style.display='none'; messageBox.removeEventListener('transitionend', handler); }, { once:true }); }, durationMs); }
    }
    window.showMessageBox = showMessageBox;

    function getCloudinaryImageUrl(urlOrPublicId, transformations = "w_auto,f_auto,q_auto"){
      if(!urlOrPublicId) return null; if(urlOrPublicId.startsWith('http://') || urlOrPublicId.startsWith('https://')) return urlOrPublicId;
      const cloudName = 'dxld01rcp'; return `https://res.cloudinary.com/${cloudName}/image/upload/${transformations}/${urlOrPublicId}`;
    }
    function displayProfilePicture(imgEl, iconEl, profilePicId, usernameInitial, transformations){
      if(!imgEl) return; if(profilePicId){ const url = getCloudinaryImageUrl(profilePicId, transformations); imgEl.src = url; imgEl.style.display='block'; if(iconEl) iconEl.style.display='none'; imgEl.onerror = ()=>{ imgEl.style.display='none'; if(iconEl) iconEl.style.display='block'; }; } else { imgEl.style.display='none'; if(iconEl) iconEl.style.display='block'; }
    }

    async function fetchAndDisplayHeaderProfile(user){
      try{
        const privateProfileDocRef = doc(db, "artifacts", appId, "users", user.uid, "profiles", "user_profile");
        const publicProfileDocRef = doc(db, "artifacts", appId, "public", "data", "users", user.uid);
        const privateSnap = await getDoc(privateProfileDocRef);
        let profileData = null;
        if (privateSnap.exists()) { profileData = privateSnap.data(); }
        else {
          profileData = { username: user.displayName || `User_${user.uid.substring(0,8)}`, email: user.email || "", profilePicId: user.photoURL || null, createdAt: serverTimestamp(), updatedAt: serverTimestamp(), totalPosts: 0, jCoins: 0, gas: 0, level: 1, banned: false };
          await setDoc(privateProfileDocRef, profileData);
        }
        await setDoc(publicProfileDocRef, { username: profileData.username, profilePicId: profileData.profilePicId, userId: user.uid, email: profileData.email, totalPosts: profileData.totalPosts, level: profileData.level, jCoins: profileData.jCoins, banned: profileData.banned }, { merge: true });
        const usernameInitial = (profileData.username || 'U').charAt(0).toUpperCase();
        displayProfilePicture(headerProfilePic, headerAvatarIcon, profileData?.profilePicId, usernameInitial, "w_70,h_70,c_fill,g_face,r_max");
        headerDisplayName.textContent = profileData.username || 'Grazzy User';
        if (profileLink) profileLink.href = `/profile.html?userId=${user.uid}`;
        logoutButton.disabled = false;
      }catch(err){
        console.error('Header profile error', err);
        headerDisplayName.textContent = user.displayName || 'Grazzy User';
        logoutButton.disabled = false;
      }
    }

    async function logAdminAction(adminUid, actionType, details={}){
      try{ await addDoc(collection(db, "artifacts", appId, "public", "data", "admin_logs"), { adminUid, actionType, details, timestamp: serverTimestamp() }); }catch(e){ console.error('logAdminAction', e); }
    }

    let currentUser = null; let reportsUnsub = null; let reportsCache = new Map();

    function applyClientFilters(raw){
      const t = (typeFilter.value || '').trim();
      const qText = (searchInput.value || '').trim().toLowerCase();
      let r = raw;
      if (t) r = r.filter(x => (x.type || x.contentType || '').toLowerCase() === t);
      if (qText){
        r = r.filter(x => {
          const fields = [x.reason, x.content, x.contentId, x.reportedId, x.reporterId, x.reportedUsername, x.reporterUsername, x.location];
          return fields.filter(Boolean).some(v => String(v).toLowerCase().includes(qText));
        });
      }
      return r;
    }

    function fmtTs(ts){ try{ const d = ts?.toDate ? ts.toDate() : (typeof ts === 'number' ? new Date(ts) : null); return d ? d.toLocaleString() : 'N/A'; }catch(_){ return 'N/A'; } }

    function renderReports(){
      const all = Array.from(reportsCache.values());
      const filtered = applyClientFilters(all).sort((a,b)=>{
        const ta = a.timestamp?.toDate ? a.timestamp.toDate().getTime() : 0;
        const tb = b.timestamp?.toDate ? b.timestamp.toDate().getTime() : 0;
        return tb - ta;
      });
      reportsCounter.textContent = `${filtered.length} Reports`;
      reportsList.innerHTML = '';
      if (!filtered.length){ emptyState.style.display='block'; return; } else { emptyState.style.display='none'; }
      for (const r of filtered){
        const item = document.createElement('div');
        item.className = 'report-card';
        item.dataset.reportId = r.id;
        const contentSnippet = (r.content || r.contentText || '').toString();
        const snippet = contentSnippet.length > 180 ? contentSnippet.slice(0,177) + '…' : contentSnippet;
        const typeLabel = (r.type || r.contentType || 'other').toString();
        const statusLabel = (r.status || 'pending').toString();
        item.innerHTML = `
          <div class="report-select"><input type="checkbox" class="row-select" aria-label="Select report"></div>
          <div class="report-meta">
            <h3 class="report-title">${r.reason || 'Reported content'} <span class="tag" title="Type"><i class="fas fa-tag"></i> ${typeLabel}</span> <span class="tag" title="Status"><i class="fas fa-info-circle"></i> ${statusLabel}</span></h3>
            <p class="report-details">Content: ${snippet || 'N/A'}</p>
            <div class="report-tags">
              <span class="tag" title="Reported User"><i class="fas fa-user-slash"></i> ${r.reportedUsername || (r.reportedId ? r.reportedId.slice(0,8)+'…' : 'Unknown')}</span>
              <span class="tag" title="Reporter"><i class="fas fa-user"></i> ${r.reporterUsername || (r.reporterId ? r.reporterId.slice(0,8)+'…' : 'Unknown')}</span>
              <span class="tag" title="Content ID"><i class="fas fa-hashtag"></i> ${(r.contentId || 'N/A').toString()}</span>
              <span class="tag" title="When"><i class="fas fa-clock"></i> ${fmtTs(r.timestamp)}</span>
              ${r.location ? `<span class="tag" title="Location"><i class="fas fa-link"></i> ${r.location}</span>` : ''}
            </div>
          </div>
          <div class="report-actions">
            <button class="btn btn-success" data-action="resolve"><i class="fas fa-check"></i> Resolve</button>
            <button class="btn btn-warning" data-action="ignore"><i class="fas fa-ban"></i> Ignore</button>
            <button class="btn" data-action="warn"><i class="fas fa-exclamation-circle"></i> Warn</button>
            <button class="btn btn-danger" data-action="delete_content"><i class="fas fa-trash"></i> Delete</button>
            <button class="btn" data-action="ban"><i class="fas fa-user-lock"></i> Ban</button>
          </div>
        `;
        reportsList.appendChild(item);
      }
    }

    function attachReportsListener(){
      if (reportsUnsub) { try{ reportsUnsub(); }catch(_){ } reportsUnsub = null; }
      reportsCache.clear(); reportsList.innerHTML=''; emptyState.style.display='none'; reportsCounter.textContent = '0 Reports';
      const st = (statusFilter.value || 'pending').trim();
      let qRef = query(collection(db, 'artifacts', appId, 'public', 'data', 'reports'), where('status','==', st), orderBy('timestamp','desc'), limit(100));
      reportsUnsub = onSnapshot(qRef, (snap)=>{
        snap.docChanges().forEach(ch => {
          const d = { id: ch.doc.id, ...ch.doc.data() };
          if (ch.type === 'removed') { reportsCache.delete(ch.doc.id); }
          else { reportsCache.set(ch.doc.id, d); }
        });
        renderReports();
      }, (err)=>{
        console.error('reports listener error', err);
        showMessageBox(`Error loading reports: ${err.message}`, 'error');
      });
    }

    async function updateReportStatus(reportId, newStatus){
      const ref = doc(db, 'artifacts', appId, 'public', 'data', 'reports', reportId);
      await updateDoc(ref, { status: newStatus, resolvedAt: serverTimestamp(), resolvedBy: currentUser.uid });
    }

    async function warnUserFromReport(report){
      if (!report?.reportedId) throw new Error('Missing reported user');
      const batch = writeBatch(db);
      const notifRef = doc(collection(db, 'artifacts', appId, 'users', report.reportedId, 'notifications'));
      batch.set(notifRef, { type: 'warning', message: `Warning regarding your recent activity: "${(report.content||'').toString().slice(0,120)}". Please follow community guidelines.`, timestamp: serverTimestamp(), read: false, issuedByAdminId: currentUser.uid, recipientId: report.reportedId, relatedReportId: report.id });
      const profileRef = doc(db, 'artifacts', appId, 'users', report.reportedId, 'profiles', 'user_profile');
      batch.set(profileRef, { warnings: 1, updatedAt: serverTimestamp() }, { merge: true });
      const reportRef = doc(db, 'artifacts', appId, 'public', 'data', 'reports', report.id);
      batch.update(reportRef, { status: 'warned', resolvedAt: serverTimestamp(), resolvedBy: currentUser.uid });
      await batch.commit();
    }

    async function deleteReportedContent(report){
      const type = (report.contentType || report.type || '').toLowerCase();
      if (type === 'post' && report.contentId){
        const postRef = doc(db, 'artifacts', appId, 'public', 'data', 'posts', report.contentId);
        try{
          const snap = await getDoc(postRef);
          if (snap.exists()){
            const data = snap.data();
            const archiveRef = doc(db, 'artifacts', appId, 'public', 'data', 'archived_posts', report.contentId);
            await setDoc(archiveRef, { ...data, archivedBy: currentUser.uid, archivedAt: serverTimestamp(), originalId: report.contentId });
            await deleteDoc(postRef);
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reports', report.id), { status: 'content_deleted', resolvedAt: serverTimestamp(), resolvedBy: currentUser.uid });
            window.__last_archived = { type:'post', id: report.contentId };
            showUndoToast('Post deleted.', async ()=>{ const aRef = doc(db, 'artifacts', appId, 'public', 'data', 'archived_posts', report.contentId); const aSnap = await getDoc(aRef); if(aSnap.exists()){ await setDoc(postRef, aSnap.data()); await deleteDoc(aRef); showMessageBox('Post restored.', 'success'); } });
          }
          return;
        }catch(e){ console.error('deleteReportedContent(post)', e); throw e; }
      }
      if (type === 'message' && report.contentId && report.chatRoomId){
        const msgRef = doc(db, 'artifacts', appId, 'public', 'data', 'chat_rooms', report.chatRoomId, 'messages', report.contentId);
        try{
          const snap = await getDoc(msgRef);
          if (snap.exists()){
            const data = snap.data();
            const archiveRef = doc(db, 'artifacts', appId, 'public', 'data', 'archived_messages', report.contentId);
            await setDoc(archiveRef, { ...data, archivedBy: currentUser.uid, archivedAt: serverTimestamp(), originalId: report.contentId, chatRoomId: report.chatRoomId });
            await deleteDoc(msgRef);
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reports', report.id), { status: 'content_deleted', resolvedAt: serverTimestamp(), resolvedBy: currentUser.uid });
            window.__last_archived = { type:'message', id: report.contentId, chatRoomId: report.chatRoomId };
            showUndoToast('Message deleted.', async ()=>{ const aRef = doc(db, 'artifacts', appId, 'public', 'data', 'archived_messages', report.contentId); const aSnap = await getDoc(aRef); if(aSnap.exists()){ const d = aSnap.data(); const restoreRef = doc(db, 'artifacts', appId, 'public', 'data', 'chat_rooms', d.chatRoomId, 'messages', report.contentId); await setDoc(restoreRef, d); await deleteDoc(aRef); showMessageBox('Message restored.', 'success'); } });
          }
          return;
        }catch(e){ console.error('deleteReportedContent(message)', e); throw e; }
      }
      throw new Error('Unsupported content type or missing IDs');
    }

    function showUndoToast(message, undoCb){
      showMessageBox(message + ' <button id="undoActionBtn" style="margin-left:12px;padding:6px 10px;border-radius:6px;font-weight:700;">Undo</button>', 'info', 10000);
      setTimeout(()=>{
        const btn = document.getElementById('undoActionBtn');
        if (btn) btn.addEventListener('click', ()=>{ try{ undoCb(); }catch(e){ console.error(e); } });
      }, 50);
    }

    async function banUserFromReport(report){
      if (!report?.reportedId) throw new Error('Missing reported user');
      const profileRef = doc(db, 'artifacts', appId, 'users', report.reportedId, 'profiles', 'user_profile');
      await setDoc(profileRef, { banned: true, bannedAt: serverTimestamp(), bannedBy: currentUser.uid }, { merge: true });
    }

    function getSelectedReportIds(){ return Array.from(reportsList.querySelectorAll('.report-card')).filter(el => el.querySelector('.row-select')?.checked).map(el => el.dataset.reportId); }

    async function handleRowAction(reportId, action){
      const report = reportsCache.get(reportId);
      if (!report){ showMessageBox('Report not found in view. Please refresh.', 'error'); return; }
      try{
        if (action === 'resolve'){ await updateReportStatus(reportId, 'resolved'); await logAdminAction(currentUser.uid, 'resolve_report', { reportId }); showMessageBox('Report resolved.', 'success'); }
        else if (action === 'ignore'){ await updateReportStatus(reportId, 'ignored'); await logAdminAction(currentUser.uid, 'ignore_report', { reportId }); showMessageBox('Report ignored.', 'info'); }
        else if (action === 'warn'){ await warnUserFromReport(report); await logAdminAction(currentUser.uid, 'warn_user', { reportId, userId: report.reportedId }); showMessageBox('User warned.', 'success'); }
        else if (action === 'delete_content'){ await deleteReportedContent(report); await logAdminAction(currentUser.uid, 'delete_reported_content', { reportId, contentId: report.contentId, type: report.contentType||report.type }); showMessageBox('Content deleted.', 'success'); }
        else if (action === 'ban'){ await banUserFromReport(report); await logAdminAction(currentUser.uid, 'ban_user', { userId: report.reportedId, reportId }); showMessageBox('User banned.', 'warning'); }
      }catch(err){ console.error('Action error', err); showMessageBox(`Action failed: ${err.message}`, 'error'); }
    }

    async function handleBulk(action){
      const ids = getSelectedReportIds(); if (!ids.length){ showMessageBox('No reports selected.', 'info'); return; }
      try{
        if (action === 'resolve' || action === 'ignore'){
          const batch = writeBatch(db);
          ids.forEach(id => { batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'reports', id), { status: action === 'resolve' ? 'resolved' : 'ignored', resolvedAt: serverTimestamp(), resolvedBy: currentUser.uid }); });
          await batch.commit();
          await logAdminAction(currentUser.uid, `bulk_${action}_reports`, { ids });
          showMessageBox(`Bulk ${action} complete.`, 'success');
        } else if (action === 'delete_content'){
          for (const id of ids){ const r = reportsCache.get(id); if (r){ await deleteReportedContent(r); } }
          await logAdminAction(currentUser.uid, 'bulk_delete_reported_content', { ids });
          showMessageBox('Bulk delete complete.', 'success');
        }
      }catch(err){ console.error('Bulk error', err); showMessageBox(`Bulk action failed: ${err.message}`, 'error'); }
    }

    onAuthStateChanged(auth, async (user)=>{
      if (user){
        currentUser = user;
        if (currentUser.uid !== ADMIN_UID){
          showMessageBox('Unauthorized access. Redirecting…', 'error', 2000, true);
          document.querySelectorAll('a, button, input, select').forEach(el => { if (el.id !== 'logoutButton') { el.disabled = true; el.classList.add('disabled-link'); } });
          setTimeout(()=>{ window.location.href = '/index.html'; }, 1500);
          return;
        }
        await fetchAndDisplayHeaderProfile(user);
        attachReportsListener();
        showMessageBox('Welcome Admin.', 'success');
      } else {
        logoutButton.disabled = true; headerDisplayName.textContent = 'Guest'; headerAvatarIcon.style.display='block'; headerProfilePic.style.display='none';
        showMessageBox('Please log in. Redirecting…', 'error', 2000, true);
        setTimeout(()=>{
          if (initialAuthToken) { signInWithCustomToken(auth, initialAuthToken).catch(()=> window.location.href='/login.html'); }
          else { signInAnonymously(auth).catch(()=> window.location.href='/login.html'); }
        }, 1200);
      }
    });

    logoutButton.addEventListener('click', async ()=>{ try{ if(currentUser){ await logAdminAction(currentUser.uid, 'admin_logout'); } await signOut(auth); showMessageBox('Logged out.', 'success'); setTimeout(()=>{ window.location.href='/login.html'; }, 1200); }catch(e){ showMessageBox('Logout failed.', 'error'); }});

    statusFilter.addEventListener('change', attachReportsListener);
    typeFilter.addEventListener('change', renderReports);
    searchInput.addEventListener('input', renderReports);
    selectAllCheckbox.addEventListener('change', ()=>{ const checked = selectAllCheckbox.checked; reportsList.querySelectorAll('.row-select').forEach(cb => { cb.checked = checked; }); });

    reportsList.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-action]'); if(!btn) return; const card = btn.closest('.report-card'); if(!card) return; const id = card.dataset.reportId; const action = btn.dataset.action; handleRowAction(id, action);
    });

    bulkResolveBtn.addEventListener('click', ()=> handleBulk('resolve'));
    bulkIgnoreBtn.addEventListener('click', ()=> handleBulk('ignore'));
    bulkDeleteBtn.addEventListener('click', ()=> handleBulk('delete_content'));
  </script>

  <script src="assets/js/lazy-images.js" defer></script>
</body>
</html>
